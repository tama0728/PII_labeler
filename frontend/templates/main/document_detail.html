{% extends 'main/base.html' %}

{% block title %}{{ document.data_id }} - PII Labeler{% endblock %}

{% block extra_css %}
<style>
.pii-tag-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 20px;
    padding: 12px;
    background-color: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.pii-tag-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 15px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.2s ease;
    position: relative;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    min-width: 80px;
}

.pii-tag-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.pii-tag-btn.selected {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    border: 2px solid #fff;
}

.pii-tag-btn.selected::after {
    content: 'âœ“';
    position: absolute;
    top: -5px;
    right: -5px;
    background: #28a745;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid white;
}

.document-text {
    position: relative;
    line-height: 1.8;
    font-size: 16px;
    padding: 20px;
    background-color: white;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    user-select: text;
    cursor: text;
    font-family: 'Courier New', monospace;
}

.document-text::selection {
    background-color: rgba(0, 123, 255, 0.3);
}

.text-selection-overlay {
    position: absolute;
    background-color: rgba(0, 123, 255, 0.2);
    border: 2px solid #007bff;
    border-radius: 4px;
    pointer-events: none;
    z-index: 10;
}

.selection-info {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    z-index: 1000;
    display: none;
    min-width: 300px;
}

.selection-info h6 {
    margin-bottom: 15px;
    color: #333;
}

.selection-info .selected-text {
    background-color: #f8f9fa;
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 15px;
    border-left: 4px solid #007bff;
}

.selection-info .btn-group {
    display: flex;
    gap: 10px;
}

.selection-info .btn {
    flex: 1;
}

.tag-instruction {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    text-align: center;
}

.tag-instruction .step {
    display: inline-block;
    margin: 0 10px;
    padding: 8px 16px;
    background: rgba(255,255,255,0.2);
    border-radius: 20px;
    font-size: 14px;
}

.tag-instruction .arrow {
    font-size: 18px;
    margin: 0 5px;
}

.existing-pii-tag {
    display: inline-block;
    padding: 2px 6px;
    margin: 0 1px;
    border-radius: 4px;
    color: white;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    z-index: 10;
    box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    border: 1px solid rgba(255,255,255,0.4);
    vertical-align: top;
    white-space: nowrap;
}

.existing-pii-tag:hover {
    transform: scale(1.1);
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    z-index: 1000 !important;
    border: 2px solid rgba(255,255,255,0.9);
    opacity: 0.7;
}

.existing-pii-tag.selected {
    border: 3px solid #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.3), 0 4px 12px rgba(0,0,0,0.2);
    z-index: 200 !important;
    transform: scale(1.1) translateY(-3px);
    animation: selected-glow 1.5s ease-in-out infinite alternate;
    opacity: 1;
}

@keyframes selected-glow {
    from { box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.3), 0 4px 12px rgba(0,0,0,0.2); }
    to { box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.6), 0 6px 16px rgba(0,0,0,0.3); }
}

/* ì—°ê²°ë˜ì§€ ì•Šì€ íƒœê·¸ë“¤ (ë…ë¦½ íƒœê·¸) */
.existing-pii-tag:not(.linked) {
    border-left: 4px solid #6c757d;
    position: relative;
    box-shadow: 0 1px 3px rgba(108, 117, 125, 0.2);
    opacity: 1;
}

.existing-pii-tag:not(.linked)::before {
    content: 'â—';
    position: absolute;
    top: -8px;
    left: -2px;
    font-size: 8px;
    background: #6c757d;
    color: white;
    border-radius: 50%;
    width: 14px;
    height: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1001;
}

/* ì—°ê²°ëœ íƒœê·¸ë“¤ ê·¸ë£¹ í‘œì‹œ */
.existing-pii-tag.linked {
    border-left: 4px solid #28a745;
    position: relative;
    box-shadow: 0 2px 6px rgba(40, 167, 69, 0.3);
    opacity: 1;
}

.existing-pii-tag.linked::before {
    content: 'ğŸ”—';
    position: absolute;
    top: -8px;
    left: -2px;
    font-size: 10px;
    background: #28a745;
    color: white;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1001;
}

/* ë…ë¦½ íƒœê·¸ í˜¸ë²„ íš¨ê³¼ */
.existing-pii-tag:not(.linked):hover {
    border-left-color: #495057;
    box-shadow: 0 2px 6px rgba(108, 117, 125, 0.3);
    opacity: 0.7;
}

/* ì—°ê²°ëœ íƒœê·¸ ê·¸ë£¹ í˜¸ë²„ íš¨ê³¼ */
.existing-pii-tag.linked:hover {
    border-left-color: #20c997;
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
    opacity: 0.7;
}

/* ë…ë¦½ íƒœê·¸ ì„ íƒ ì‹œ */
.existing-pii-tag:not(.linked).selected {
    border-left-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.3), 0 2px 6px rgba(108, 117, 125, 0.3);
    opacity: 1;
}

.existing-pii-tag:not(.linked).selected::before {
    background: #007bff;
}

/* ì—°ê²°ëœ íƒœê·¸ ê·¸ë£¹ ì„ íƒ ì‹œ */
.existing-pii-tag.linked.selected {
    border-left-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.3), 0 4px 12px rgba(40, 167, 69, 0.3);
}

.existing-pii-tag.linked.selected::before {
    background: #007bff;
}

.existing-pii-tag .delete-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    width: 16px;
    height: 16px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 10px;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    z-index: 1002;
    white-space: nowrap;
    transform: translateZ(0);
}

.existing-pii-tag:hover .delete-btn {
    display: flex;
}

.existing-pii-tag .delete-btn:hover {
    background: #c82333;
    transform: scale(1.1);
}

.entity-details-panel {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    height: fit-content;
    position: sticky;
    top: 20px;
}

.entity-details-panel h3 {
    margin-bottom: 20px;
    color: #333;
    font-size: 18px;
    font-weight: 600;
    border-bottom: 2px solid #007bff;
    padding-bottom: 10px;
}

.entity-details-row {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.entity-details-row .field-group {
    flex: 1;
}

.field-group {
    margin-bottom: 15px;
}

.field-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #555;
    font-size: 13px;
}

.field-group input,
.field-group select,
.field-group textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 13px;
    transition: border-color 0.2s ease;
}

.field-group input:focus,
.field-group select:focus,
.field-group textarea:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
}

.help-text {
    color: #666;
    font-size: 11px;
    margin-top: 5px;
    display: block;
}

@media (max-width: 768px) {
    .pii-tag-buttons {
        flex-direction: column;
    }
    
    .pii-tag-btn {
        width: 100%;
        text-align: center;
    }
    
    .tag-instruction .step {
        display: block;
        margin: 5px 0;
    }
    
    .tag-instruction .arrow {
        display: none;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- ë¬¸ì„œ í—¤ë” -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <a href="{% url 'document_list' %}" class="btn btn-outline-secondary btn-sm me-3">
                            <i class="fas fa-arrow-left"></i> ëª©ë¡ìœ¼ë¡œ
                        </a>
                        <h4 class="mb-0">{{ document.data_id }}</h4>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <span class="badge bg-light text-dark mx-1">Ctrl + â†, â†’</span>
                            <span class="text-muted me-2">ì´ì „, ë‹¤ìŒ ë¬¸ì„œ</span>
                            {% if prev_document %}
                            <a href="{% url 'document_detail' prev_document.pk %}" class="btn btn-outline-primary btn-sm" title="ì´ì „ ë¬¸ì„œ: {{ prev_document.data_id }} (Ctrl + â†)">
                                <i class="fas fa-chevron-left"></i> ì´ì „
                                <small class="d-block">{{ prev_document.data_id }}</small>
                            </a>
                            {% else %}
                            <button class="btn btn-outline-secondary btn-sm" disabled title="ì²« ë²ˆì§¸ ë¬¸ì„œì…ë‹ˆë‹¤">
                                <i class="fas fa-chevron-left"></i> ì´ì „
                                <small class="d-block">-</small>
                            </button>
                            {% endif %}
                            
                            {% if next_document %}
                            <a href="{% url 'document_detail' next_document.pk %}" class="btn btn-outline-primary btn-sm ms-2" title="ë‹¤ìŒ ë¬¸ì„œ: {{ next_document.data_id }} (Ctrl + â†’)">
                                ë‹¤ìŒ <i class="fas fa-chevron-right"></i>
                                <small class="d-block">{{ next_document.data_id }}</small>
                            </a>
                            {% else %}
                            <button class="btn btn-outline-secondary btn-sm ms-2" disabled title="ë§ˆì§€ë§‰ ë¬¸ì„œì…ë‹ˆë‹¤">
                                ë‹¤ìŒ <i class="fas fa-chevron-right"></i>
                                <small class="d-block">-</small>
                            </button>
                            {% endif %}
                        </div>
                        <div>
                            <span class="badge bg-secondary">{{ document.created_at|date:"Y-m-d H:i" }}</span>
                            <span class="badge bg-info">{{ pii_tags.count }} PII íƒœê·¸</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- íƒœê·¸ ì¶”ê°€ ì•ˆë‚´ -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="tag-instruction">
                <div class="step">1. í…ìŠ¤íŠ¸ ë“œë˜ê·¸</div>
                <span class="arrow">â†’</span>
                <div class="step">2. ë¼ë²¨ ì„ íƒ</div>
                <span class="arrow">â†’</span>
                <div class="step">3. íƒœê·¸ ì¶”ê°€</div>
            </div>
        </div>
    </div>

    <!-- PII íƒœê·¸ ë²„íŠ¼ë“¤ -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="pii-tag-buttons">
                {% for category in pii_categories %}
                <button class="pii-tag-btn" 
                        data-tag-type="{{ category.value }}"
                        style="background-color: {{ category.background_color }};"
                        title="{{ category.description }}">
                    {{ category.value }}
                    <small class="d-block" style="font-size: 10px; opacity: 0.9;">{{ category.description|truncatechars:15 }}</small>
                </button>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <!-- ë¬¸ì„œ í…ìŠ¤íŠ¸ -->
                    <div class="document-text" id="document-text" data-original-text="{{ document.text }}">
                        {{ document.text|linebreaks }}
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-secondary" onclick="location.reload()">
                            <i class="fas fa-refresh"></i> ìƒˆë¡œê³ ì¹¨
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="entity-details-panel">
                <h3>ì–´ë…¸í…Œì´ì…˜ ìƒì„¸ ì •ë³´</h3>
                
                <div class="entity-details-row">
                    <div class="field-group">
                        <label>ì„ íƒëœ í…ìŠ¤íŠ¸:</label>
                        <input type="text" id="selectedText" readonly style="background: #f8f9fa; color: #666; border: 1px solid #e8e8e8; padding: 6px 8px; border-radius: 3px; font-size: 12px; width: 100%;">
                    </div>
                    
                    <div class="field-group">
                        <label>ì—”í‹°í‹° íƒ€ì…:</label>
                        <input type="text" id="entityType" readonly style="background: #f8f9fa; color: #666; border: 1px solid #e8e8e8; padding: 6px 8px; border-radius: 3px; font-size: 12px; width: 100%;">
                    </div>
                </div>
                
                <div class="auto-generated" style="margin-bottom: 16px;">
                    <label>ì‘ì—…ì (annotator):</label>
                    <input type="text" id="annotator" value="Anonymous" readonly style="background: #f8f9fa; color: #666; border: 1px solid #e8e8e8; width: 100%;">
                </div>
                
                <div class="field-group">
                    <label>ì‹ë³„ì ìœ í˜• (identifier_type):</label>
                    <select id="identifierType" onchange="updateIdentifierTypeAndSave()">
                        <option value="default">default (ë§ˆìŠ¤í‚¹ í•„ìš” ì—†ìŒ)</option>
                        <option value="direct">ì§ì ‘ì‹ë³„ì</option>
                        <option value="quasi">ì¤€ì‹ë³„ì</option>
                    </select>
                </div>
                
                <div class="field-group">
                    <label>ì—°ê²°ëœ ì–´ë…¸í…Œì´ì…˜ (entity_id):</label>
                    <select id="linkedAnnotation" onchange="updateEntityIdAndSave()">
                        <option value="">ë…ë¦½ ì–´ë…¸í…Œì´ì…˜</option>
                    </select>
                    <small class="help-text">ê°™ì€ ê°ì²´ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì–´ë…¸í…Œì´ì…˜ë“¤ì„ ì—°ê²°í•©ë‹ˆë‹¤.</small>
                </div>
                
                <div class="field-group">
                    <label>JSON ìƒì„¸ ì •ë³´:</label>
                    <textarea id="jsonDisplay" style="
                        width: 100%; 
                        height: 200px; 
                        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; 
                        font-size: 12px; 
                        background: #f8f9fa; 
                        border: 1px solid #e8e8e8; 
                        border-radius: 4px; 
                        padding: 12px; 
                        resize: vertical;
                        color: #333;
                        line-height: 1.4;
                    " placeholder="ì–´ë…¸í…Œì´ì…˜ì„ ì„ íƒí•˜ë©´ JSON ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤."></textarea>
                </div>
                
                <div class="field-group">
                    <label>ë©”íƒ€ë°ì´í„° (metadata):</label>
                    <textarea id="metadata" readonly style="background: #f8f9fa; color: #666; border: 1px solid #e8e8e8; padding: 8px; border-radius: 3px; font-size: 12px; resize: vertical; min-height: 180px; font-family: monospace; width: 100%; box-sizing: border-box;" placeholder="ë©”íƒ€ë°ì´í„°ê°€ í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
                    <small class="help-text">íŒŒì¼ ì •ë³´ ë° íƒœìŠ¤í¬ ê´€ë ¨ ë©”íƒ€ë°ì´í„°</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- í…ìŠ¤íŠ¸ ì„ íƒ í™•ì¸ ëª¨ë‹¬ -->
<div class="selection-info" id="selection-info">
    <h6><i class="fas fa-tag"></i> PII íƒœê·¸ ì¶”ê°€</h6>
    <div class="selected-text">
        <strong>ì„ íƒëœ íƒœê·¸:</strong> <span id="selected-tag-name"></span><br>
        <strong>ì„ íƒëœ í…ìŠ¤íŠ¸:</strong> "<span id="selected-text-preview"></span>"<br>
        <small class="text-muted" id="selected-position"></small>
    </div>
    <div class="btn-group">
        <button type="button" class="btn btn-success" id="confirm-tag-btn">
            <i class="fas fa-check"></i> íƒœê·¸ ì¶”ê°€
        </button>
        <button type="button" class="btn btn-secondary" id="cancel-tag-btn">
            <i class="fas fa-times"></i> ì·¨ì†Œ
        </button>
    </div>
</div>

<!-- CSRF í† í° -->
{% csrf_token %}
{% endblock %}

{% block extra_js %}
<script>
// ì „ì—­ í•¨ìˆ˜ë“¤
function updateLinkedAnnotationDropdown(currentTagId) {
    const dropdown = document.getElementById('linkedAnnotation');
    dropdown.innerHTML = '<option value="">ë…ë¦½ ì–´ë…¸í…Œì´ì…˜</option>';

    // í˜„ì¬ ë¬¸ì„œì˜ ëª¨ë“  ì–´ë…¸í…Œì´ì…˜ì„ ì—”í‹°í‹° ê·¸ë£¹ìœ¼ë¡œ ë¬¶ê¸°
    const allTags = Array.from(document.querySelectorAll('.existing-pii-tag')).map(el => JSON.parse(el.dataset.tagData));
    const currentTagData = JSON.parse(document.querySelector(`[data-tag-id="${currentTagId}"]`).dataset.tagData);

    const entityIdToTags = new Map();
    allTags.forEach(tag => {
        if (!entityIdToTags.has(tag.entity_id)) {
            entityIdToTags.set(tag.entity_id, []);
        }
        entityIdToTags.get(tag.entity_id).push(tag);
    });

    // ê° ì—”í‹°í‹° ê·¸ë£¹ì˜ ëŒ€í‘œ í…ìŠ¤íŠ¸: span_id == entity_id ì¸ íƒœê·¸ì˜ span_text
    entityIdToTags.forEach((tags, entityId) => {
        // entity_idê°€ ì—†ìœ¼ë©´ ìŠ¤í‚µ
        if (!entityId) return;
        // í˜„ì¬ íƒœê·¸ê°€ ë…ë¦½(ìê¸° span_id)ì¼ ë•Œ, ê·¸ ìê¸° span_id ê·¸ë£¹ë§Œ ìˆ¨ê¹€
        // ì´ë¯¸ ë‹¤ë¥¸ ê·¸ë£¹(entity_id)ë¡œ ì—°ê²°ëœ ê²½ìš°, ê·¸ ê·¸ë£¹ì€ í‘œì‹œë˜ì–´ì•¼ í•¨
        const currentTagData = JSON.parse(document.querySelector(`[data-tag-id="${currentTagId}"]`).dataset.tagData);
        const isOwnIndependentGroup = String(entityId) === String(currentTagData.span_id);
        if (isOwnIndependentGroup) return;

        // ëŒ€í‘œ í…ìŠ¤íŠ¸ ë° ëŒ€í‘œ ìœ„ì¹˜ ì„ íƒ
        let representativeText = '';
        let repStart = '';
        let repEnd = '';
        const rep = tags.find(t => t.span_id && t.entity_id && String(t.span_id) === String(t.entity_id));
        if (rep) {
            representativeText = rep.text;
            repStart = rep.start;
            repEnd = rep.end;
        } else {
            representativeText = tags[0]?.text || '';
            repStart = tags[0]?.start ?? '';
            repEnd = tags[0]?.end ?? '';
        }

        // ì˜µì…˜ ìƒì„± (ê°’ì€ entity_id)
        const option = document.createElement('option');
        option.value = entityId;
        option.textContent = `${representativeText} (entity_id: ${entityId}, pos: ${repStart}-${repEnd})`;
        dropdown.appendChild(option);
    });
}

function updateEntityIdAndSave() {
    const dropdown = document.getElementById('linkedAnnotation');
    const selectedEntityId = dropdown.value; // entity_id ê°’
    const currentTagElement = document.querySelector('.existing-pii-tag.selected');
    
    if (!currentTagElement) {
        console.log('ì„ íƒëœ íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    const currentTagData = JSON.parse(currentTagElement.dataset.tagData);
    let newEntityId = '';
    
    if (!selectedEntityId) {
        // ë…ë¦½ ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ì„¤ì • (span_idì™€ ë™ì¼)
        newEntityId = currentTagData.span_id;
    } else {
        // ì„ íƒëœ entity_id ê·¸ë£¹ê³¼ ì—°ê²°
        const allTagElements = document.querySelectorAll('.existing-pii-tag');
        const connectedTags = [];
        allTagElements.forEach(tagElement => {
            const tagData = JSON.parse(tagElement.dataset.tagData);
            if (String(tagData.entity_id) === String(selectedEntityId)) {
                connectedTags.push(tagElement);
            }
        });
        
        // í˜„ì¬ ì„ íƒëœ íƒœê·¸ë„ ì¶”ê°€
        connectedTags.push(currentTagElement);

        // í˜„ì¬ íƒœê·¸ê°€ ëŒ€í‘œ( span_id == entity_id )ì˜€ë‹¤ë©´,
        // ìì‹ ì˜ span_idì— ì—°ê²°ë˜ì–´ ìˆë˜ ë‹¤ë¥¸ íƒœê·¸ë“¤ë„ ê°™ì´ ì—°ê²°
        if (String(currentTagData.span_id) === String(currentTagData.entity_id)) {
            allTagElements.forEach(tagElement => {
                const tagData = JSON.parse(tagElement.dataset.tagData);
                if (String(tagData.entity_id) === String(currentTagData.span_id)) {
                    // ì¤‘ë³µ ì¶”ê°€ ë°©ì§€
                    if (!connectedTags.includes(tagElement)) {
                        connectedTags.push(tagElement);
                    }
                }
            });
        }
        
        // ê°€ì¥ ì‘ì€ span_idë¥¼ entity_idë¡œ ì‚¬ìš©
        const minSpanId = Math.min(...connectedTags.map(tag => {
            const data = JSON.parse(tag.dataset.tagData);
            return parseInt(data.span_id) || 0;
        }));
        
        newEntityId = minSpanId.toString();
        
        // ëª¨ë“  ì—°ê²°ëœ íƒœê·¸ì˜ entity_id ì—…ë°ì´íŠ¸ ë° ì„œë²„ ì €ì¥
        connectedTags.forEach(tagElement => {
            updateTagEntityId(tagElement, newEntityId);
        });
    }
    
    // í˜„ì¬ íƒœê·¸ì˜ entity_id ì—…ë°ì´íŠ¸
    updateTagEntityId(currentTagElement, newEntityId);
    
    // ì„œë²„ì— ì €ì¥
    // 1) í˜„ì¬ íƒœê·¸ ì €ì¥
    saveTagUpdate(currentTagData.id, currentTagData.category, document.getElementById('identifierType').value, newEntityId);
    // 2) ëŒ€í‘œ ì´ë™ ì‹œ í•¨ê»˜ ì—°ê²°ëœ íƒœê·¸ë“¤ë„ ì €ì¥
    if (selectedEntityId) {
        const allTagElements = document.querySelectorAll('.existing-pii-tag');
        allTagElements.forEach(tagElement => {
            const data = JSON.parse(tagElement.dataset.tagData);
            if (String(data.entity_id) === String(newEntityId) && data.id !== currentTagData.id) {
                const idType = data.identifier_type || document.getElementById('identifierType').value || 'default';
                saveTagUpdate(data.id, data.category, idType, newEntityId);
            }
        });
    }
}

function updateIdentifierTypeAndSave() {
    const currentTagElement = document.querySelector('.existing-pii-tag.selected');
    
    if (!currentTagElement) {
        console.log('ì„ íƒëœ íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    const currentTagData = JSON.parse(currentTagElement.dataset.tagData);
    const identifierType = document.getElementById('identifierType').value || 'default';
    
    // ì„œë²„ì— ì €ì¥
    saveTagUpdate(currentTagData.id, currentTagData.category, identifierType, currentTagData.entity_id);
}

function saveTagUpdate(tagId, piiCategoryValue, identifierType, entityId) {
    const formData = new FormData();
    formData.append('tag_id', tagId);
    formData.append('pii_category_value', piiCategoryValue);
    formData.append('identifier_type', identifierType);
    formData.append('entity_id', entityId);
    
    fetch('{% url "update_pii_tag" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('íƒœê·¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
            // JSON í‘œì‹œ ì—…ë°ì´íŠ¸
            updateJsonDisplay();

            // ë¡œì»¬ ë°ì´í„° ë™ê¸°í™”: identifier_type, entity_id ë°˜ì˜
            const tagElement = document.querySelector(`[data-tag-id="${tagId}"]`);
            if (tagElement) {
                const localData = JSON.parse(tagElement.dataset.tagData);
                localData.identifier_type = identifierType || 'default';
                if (entityId) {
                    localData.entity_id = entityId;
                }
                tagElement.dataset.tagData = JSON.stringify(localData);

                // í˜„ì¬ ì„ íƒëœ íƒœê·¸ë¼ë©´ ë“œë¡­ë°•ìŠ¤ ê°’ë„ ê°±ì‹ 
                if (tagElement.classList.contains('selected')) {
                    const identifierSelect = document.getElementById('identifierType');
                    if (identifierSelect) identifierSelect.value = localData.identifier_type || 'default';
                }
                
                // ë§í¬ ìŠ¤íƒ€ì¼ ì¬ì ìš©
                applyLinkedTagStyles();
            }
        } else {
            console.error('íƒœê·¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', data.message);
        }
    })
    .catch(error => {
        console.error('íƒœê·¸ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
    });
}

function updateTagEntityId(tagElement, newEntityId) {
    const tagData = JSON.parse(tagElement.dataset.tagData);
    tagData.entity_id = newEntityId;
    tagElement.dataset.tagData = JSON.stringify(tagData);
    
    // JSON í‘œì‹œ ì—…ë°ì´íŠ¸
    updateJsonDisplay();
}

function updateCurrentTagEntityId(newEntityId) {
    const currentTagElement = document.querySelector('.existing-pii-tag.selected');
    if (currentTagElement) {
        const tagData = JSON.parse(currentTagElement.dataset.tagData);
        if (newEntityId) {
            tagData.entity_id = newEntityId;
        } else {
            // ë…ë¦½ ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ì„¤ì • (span_idì™€ ë™ì¼)
            tagData.entity_id = tagData.span_id;
        }
        currentTagElement.dataset.tagData = JSON.stringify(tagData);
        updateJsonDisplay();
    }
}

function updateJsonDisplay() {
    const currentTagElement = document.querySelector('.existing-pii-tag.selected');
    if (currentTagElement) {
        const tagData = JSON.parse(currentTagElement.dataset.tagData);
        const jsonData = {
            span_text: tagData.text,
            entity_type: tagData.category,
            start_offset: tagData.start,
            end_offset: tagData.end,
            span_id: tagData.span_id,
            entity_id: tagData.entity_id,
            annotator: tagData.annotator || "Anonymous",
            identifier_type: tagData.identifier_type || 'default'
        };
        
        document.getElementById('jsonDisplay').value = JSON.stringify(jsonData, null, 2);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    let selectedTagType = null;
    let selectedText = '';
    let selectionStart = 0;
    let selectionEnd = 0;
    let isSelecting = false;
    
    // PII íƒœê·¸ ë²„íŠ¼ë“¤
    const tagButtons = document.querySelectorAll('.pii-tag-btn');
    const documentText = document.querySelector('.document-text');
    const selectionInfo = document.querySelector('#selection-info');
    const confirmTagBtn = document.querySelector('#confirm-tag-btn');
    const cancelTagBtn = document.querySelector('#cancel-tag-btn');
    
    // ê¸°ì¡´ PII íƒœê·¸ë“¤ ë Œë”ë§
    function renderExistingTags() {
        const originalText = documentText.dataset.originalText;
        let htmlContent = originalText;
        
        // PII íƒœê·¸ë“¤ì„ ì‹œì‘ ìœ„ì¹˜ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
        const sortedTags = [
            {% for tag in pii_tags %}
            {
                id: {{ tag.id }},
                start: {{ tag.start_offset }},
                end: {{ tag.end_offset }},
                text: "{{ tag.span_text|escapejs }}",
                color: "{{ tag.pii_category.background_color }}",
                category: "{{ tag.pii_category.value }}",
                span_id: "{{ tag.span_id|escapejs }}",
                entity_id: "{{ tag.entity_id|escapejs }}",
                annotator: "{{ tag.annotator|escapejs }}",
                identifier_type: "{{ tag.identifier_type|escapejs }}"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ].sort((a, b) => a.start - b.start);
        
        // ë’¤ì—ì„œë¶€í„° íƒœê·¸ë¥¼ ì‚½ì… (ì¸ë±ìŠ¤ ë³€í™” ë°©ì§€)
        for (let i = sortedTags.length - 1; i >= 0; i--) {
            const tag = sortedTags[i];
            const beforeTag = htmlContent.substring(0, tag.start);
            const afterTag = htmlContent.substring(tag.end);
            const tagHtml = `<span class="existing-pii-tag" style="background-color: ${tag.color};" title="${tag.category}: ${tag.text}" data-tag-id="${tag.id}" data-tag-data='${JSON.stringify(tag)}' onclick="selectExistingTag(${tag.id})">${tag.text}<button class="delete-btn" onclick="deleteTag(${tag.id}); event.stopPropagation();" title="íƒœê·¸ ì‚­ì œ">Ã—</button></span>`;
            htmlContent = beforeTag + tagHtml + afterTag;
        }
        
        // ì¤„ë°”ê¿ˆ ì²˜ë¦¬
        htmlContent = htmlContent.replace(/\n/g, '<br>');
        documentText.innerHTML = htmlContent;
        
        // ì—°ê²°ëœ íƒœê·¸ë“¤ì— CSS í´ë˜ìŠ¤ ì ìš©
        setTimeout(() => {
            applyLinkedTagStyles();
        }, 100);
    }
    
    // ì—°ê²°ëœ íƒœê·¸ë“¤ì— ìŠ¤íƒ€ì¼ ì ìš©
    function applyLinkedTagStyles() {
        const allTags = document.querySelectorAll('.existing-pii-tag');
        
        // ë¨¼ì € ëª¨ë“  íƒœê·¸ì—ì„œ linked í´ë˜ìŠ¤ ì œê±°
        allTags.forEach(tag => {
            tag.classList.remove('linked');
        });
        
        const entityGroups = {};
        
        // entity_idë³„ë¡œ íƒœê·¸ë“¤ì„ ê·¸ë£¹í™”
        allTags.forEach(tag => {
            const tagData = JSON.parse(tag.dataset.tagData);
            const entityId = tagData.entity_id;
            
            if (!entityGroups[entityId]) {
                entityGroups[entityId] = [];
            }
            entityGroups[entityId].push(tag);
        });
        
        // ì—°ê²°ëœ íƒœê·¸ë“¤ì— ìŠ¤íƒ€ì¼ ì ìš©
        Object.values(entityGroups).forEach(group => {
            if (group.length > 1) {
                // ê°™ì€ entity_idë¥¼ ê°€ì§„ íƒœê·¸ê°€ 2ê°œ ì´ìƒì¸ ê²½ìš° (ì—°ê²°ëœ íƒœê·¸)
                group.forEach(tag => {
                    tag.classList.add('linked');
                });
            } else if (group.length === 1) {
                // í˜¼ìë§Œ ìˆëŠ” ê·¸ë£¹ì¸ ê²½ìš°, ë…ë¦½ íƒœê·¸ì¸ì§€ í™•ì¸
                const tag = group[0];
                const tagData = JSON.parse(tag.dataset.tagData);
                
                // span_idì™€ entity_idê°€ ë‹¤ë¥´ë©´ ì—°ê²°ëœ íƒœê·¸ (linked í´ë˜ìŠ¤ ì¶”ê°€)
                if (String(tagData.span_id) !== String(tagData.entity_id)) {
                    tag.classList.add('linked');
                }
                // span_idì™€ entity_idê°€ ê°™ìœ¼ë©´ ë…ë¦½ íƒœê·¸ (linked í´ë˜ìŠ¤ëŠ” ì´ë¯¸ ì œê±°ë¨)
            }
        });
    }
    
    // ì—°ê²°ëœ íƒœê·¸ë“¤ í•˜ì´ë¼ì´íŠ¸
    function highlightLinkedTags(entityId) {
        const allTags = document.querySelectorAll('.existing-pii-tag');
        
        // ë¨¼ì € ëª¨ë“  íƒœê·¸ì—ì„œ linked í´ë˜ìŠ¤ ì œê±°
        allTags.forEach(tag => {
            tag.classList.remove('linked');
        });
        
        allTags.forEach(tag => {
            const tagData = JSON.parse(tag.dataset.tagData);
            
            if (String(tagData.entity_id) === String(entityId)) {
                // ê°™ì€ entity_idë¥¼ ê°€ì§„ íƒœê·¸ë“¤ ì²˜ë¦¬
                
                // span_idì™€ entity_idê°€ ë‹¤ë¥´ë©´ ì—°ê²°ëœ íƒœê·¸
                if (String(tagData.span_id) !== String(tagData.entity_id)) {
                    // ì—°ê²°ëœ íƒœê·¸ëŠ” linked í´ë˜ìŠ¤ ì¶”ê°€
                    tag.classList.add('linked');
                }
                // span_idì™€ entity_idê°€ ê°™ìœ¼ë©´ ë…ë¦½ íƒœê·¸ (linked í´ë˜ìŠ¤ëŠ” ì´ë¯¸ ì œê±°ë¨)
                
                // ì„ íƒëœ íƒœê·¸ê°€ ì•„ë‹Œ ê²½ìš° ì•½ê°„ì˜ íˆ¬ëª…ë„ ì ìš©
                if (!tag.classList.contains('selected')) {
                    tag.style.opacity = '0.9';
                    tag.style.transform = 'scale(1.02)';
                }
            } else {
                // ë‹¤ë¥¸ ê·¸ë£¹ì˜ íƒœê·¸ë“¤ì€ ë” íˆ¬ëª…í•˜ê²Œ í‘œì‹œ
                tag.style.opacity = '0.4';
                tag.style.transform = 'scale(0.85)';
                tag.style.filter = 'grayscale(0.5)';
            }
        });
    }
    
    // íƒœê·¸ ì„ íƒ í•´ì œ ì‹œ ëª¨ë“  íƒœê·¸ ì›ë˜ ìƒíƒœë¡œ ë³µì›
    function clearTagHighlights() {
        const allTags = document.querySelectorAll('.existing-pii-tag');
        
        allTags.forEach(tag => {
            tag.style.opacity = '';
            tag.style.transform = '';
            tag.style.filter = '';
        });
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ íƒœê·¸ë“¤ ë Œë”ë§
    renderExistingTags();
    
    // íƒœê·¸ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
    tagButtons.forEach(button => {
        button.addEventListener('click', function() {
            // í˜„ì¬ ì„ íƒëœ íƒœê·¸ê°€ ìˆëŠ”ì§€ í™•ì¸
            const selectedTag = document.querySelector('.existing-pii-tag.selected');
            if (selectedTag) {
                // ê¸°ì¡´ íƒœê·¸ì˜ íƒ€ì…ì„ ë³€ê²½
                const newTagType = this.dataset.tagType;
                updateExistingTagType(selectedTag, newTagType);
                
                // ëª¨ë“  ë²„íŠ¼ì—ì„œ selected í´ë˜ìŠ¤ ì œê±°
                tagButtons.forEach(btn => btn.classList.remove('selected'));
                // í´ë¦­ëœ ë²„íŠ¼ì— selected í´ë˜ìŠ¤ ì¶”ê°€
                this.classList.add('selected');
                selectedTagType = newTagType;
            } else if (selectedText && selectedText.length > 0) {
                // í…ìŠ¤íŠ¸ê°€ ì„ íƒëœ ìƒíƒœì—ì„œ ë¼ë²¨ ì„ íƒ
                const newTagType = this.dataset.tagType;
                
                // ë°”ë¡œ íƒœê·¸ ì¶”ê°€
                addPiiTag(newTagType, selectedText, selectionStart, selectionEnd);
                // ì„ íƒ ì •ë³´ í‘œì‹œ
                //showSelectionInfo(selectedText, selectionStart, selectionEnd);

                // ëª¨ë“  ë²„íŠ¼ì—ì„œ selected í´ë˜ìŠ¤ ì œê±°
                tagButtons.forEach(btn => btn.classList.remove('selected'));
                // í´ë¦­ëœ ë²„íŠ¼ì— selected í´ë˜ìŠ¤ ì¶”ê°€
                this.classList.add('selected');
                selectedTagType = newTagType;
            } else {
                // ì•„ë¬´ê²ƒë„ ì„ íƒë˜ì§€ ì•Šì€ ìƒíƒœì—ì„œëŠ” ì„ íƒ ë¶ˆê°€
                // ì¡°ìš©íˆ ë¬´ì‹œ (ì•Œë¦¼ ë©”ì‹œì§€ ì œê±°)
            }
        });
    });
    
    // í…ìŠ¤íŠ¸ ì„ íƒ ì‹œì‘
    documentText.addEventListener('mousedown', function(e) {
        clearTagHighlights();
        clearSelection();
        isSelecting = true;
        documentText.style.userSelect = 'text';

        // ê¸°ì¡´ ì„ íƒ ì •ë³´ ìˆ¨ê¸°ê¸°
        hideSelectionInfo();
    });
    
    // DOM ì„ íƒ Rangeë¥¼ ì›ë³¸ í…ìŠ¤íŠ¸ ì˜¤í”„ì…‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ìœ í‹¸ë¦¬í‹°
    function computeOffsetsFromSelection(rootElement, selectionRange) {
        // logical length: TEXT -> length, BR -> 1 ("\n"), .delete-btn -> 0, others -> sum(children)
        function logicalLength(node) {
            if (!node) return 0;
            if (node.nodeType === Node.TEXT_NODE) {
                return node.nodeValue.length;
            }
            if (node.nodeType === Node.ELEMENT_NODE) {
                const el = node;
                if (el.classList && el.classList.contains('delete-btn')) {
                    return 0;
                }
                if (el.tagName === 'BR') {
                    return 1;
                }
                let total = 0;
                let child = el.firstChild;
                while (child) {
                    total += logicalLength(child);
                    child = child.nextSibling;
                }
                return total;
            }
            return 0;
        }

        // Traverse to assign starting logical positions for elements and text nodes
        const elementStartPos = new Map();
        const textNodeStartPos = new Map();
        let pos = 0;
        function assignPositions(node) {
            if (!node) return;
            if (node.nodeType === Node.TEXT_NODE) {
                textNodeStartPos.set(node, pos);
                pos += node.nodeValue.length;
                return;
            }
            if (node.nodeType === Node.ELEMENT_NODE) {
                const el = node;
                if (el.classList && el.classList.contains('delete-btn')) {
                    return;
                }
                if (el.tagName === 'BR') {
                    pos += 1;
                    return;
                }
                elementStartPos.set(el, pos);
                let child = el.firstChild;
                while (child) {
                    assignPositions(child);
                    child = child.nextSibling;
                }
            }
        }
        assignPositions(rootElement);

        function positionFor(container, offset) {
            if (!container) return 0;
            if (container.nodeType === Node.TEXT_NODE) {
                const base = textNodeStartPos.get(container) || 0;
                return base + offset;
            }
            if (container.nodeType === Node.ELEMENT_NODE) {
                const base = elementStartPos.get(container) || 0;
                let total = 0;
                let i = 0;
                let child = container.firstChild;
                while (child && i < offset) {
                    total += logicalLength(child);
                    child = child.nextSibling;
                    i++;
                }
                return base + total;
            }
            return 0;
        }

        const start = positionFor(selectionRange.startContainer, selectionRange.startOffset);
        const end = positionFor(selectionRange.endContainer, selectionRange.endOffset);
        return { start, end };
    }

    // í…ìŠ¤íŠ¸ ì„ íƒ ì¤‘
    documentText.addEventListener('mouseup', function(e) {
        if (!isSelecting) return;
        
        setTimeout(() => {
            const selection = window.getSelection();
            const originalText = selection.toString();
            
            if (originalText && originalText.length > 0) {
                // ê³µë°± íŠ¸ë¦¼ ì²˜ë¦¬
                const trimmedText = originalText.trim();
                const leftTrimCount = originalText.length - originalText.trimStart().length;
                const rightTrimCount = originalText.length - originalText.trimEnd().length;
                
                // ëª¨ë“  íƒœê·¸ ë²„íŠ¼ì—ì„œ selected í´ë˜ìŠ¤ ì œê±°
                tagButtons.forEach(btn => btn.classList.remove('selected'));
                selectedTagType = null;
                
                // ëª¨ë“  ê¸°ì¡´ íƒœê·¸ì—ì„œ selected í´ë˜ìŠ¤ ì œê±°
                document.querySelectorAll('.existing-pii-tag').forEach(tag => {
                    tag.classList.remove('selected');
                });
                selectedText = trimmedText;
                
                // DOM Rangeë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì •í™•í•œ ì˜¤í”„ì…‹ ê³„ì‚° (ì¤‘ë³µ ë¬¸ìì—´ ëŒ€ì‘)
                let startOffset = -1;
                let endOffset = -1;
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const offsets = computeOffsetsFromSelection(documentText, range);
                    startOffset = offsets.start + leftTrimCount;  // ì™¼ìª½ ê³µë°±ë§Œí¼ ì˜¤í”„ì…‹ ì¡°ì •
                    endOffset = offsets.end - rightTrimCount;    // ì˜¤ë¥¸ìª½ ê³µë°±ë§Œí¼ ì˜¤í”„ì…‹ ì¡°ì •
                }

                if (startOffset !== -1 && endOffset !== -1) {
                    selectionStart = startOffset;
                    selectionEnd = endOffset;

                    // ì„ íƒëœ í…ìŠ¤íŠ¸ í‘œì‹œ (íŠ¸ë¦¼ëœ í…ìŠ¤íŠ¸ ì‚¬ìš©)
                    showSelectedTextInfo(trimmedText, startOffset, endOffset);
                } else {
                    alert('ì„ íƒëœ í…ìŠ¤íŠ¸ë¥¼ ì›ë³¸ ë¬¸ì„œì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            }
        }, 10);
        
        isSelecting = false;
    });
    
    // ì„ íƒëœ í…ìŠ¤íŠ¸ ì •ë³´ í‘œì‹œ (ë¼ë²¨ ì„ íƒ ì „)
    function showSelectedTextInfo(text, start, end) {
        // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
        selectedText = text;
        selectionStart = start;
        selectionEnd = end;
        
        // ìƒì„¸ ì •ë³´ íŒ¨ë„ì— ì„ íƒëœ í…ìŠ¤íŠ¸ í‘œì‹œ
        document.getElementById('selectedText').value = text;
        document.getElementById('entityType').value = '';
        document.querySelector('#selected-position').textContent = `ìœ„ì¹˜: ${start}-${end}`;
    }
    
    // ì„ íƒ ì •ë³´ í‘œì‹œ (ë¼ë²¨ ì„ íƒ í›„)
    function showSelectionInfo(text, start, end) {
        const selectedTagButton = document.querySelector('.pii-tag-btn.selected');
        const tagName = selectedTagButton ? selectedTagButton.textContent.split('\n')[0] : 'Unknown';
        
        document.querySelector('#selected-tag-name').textContent = tagName;
        document.querySelector('#selected-text-preview').textContent = text;
        document.querySelector('#selected-position').textContent = `ìœ„ì¹˜: ${start}-${end}`;
        
        selectionInfo.style.display = 'block';
    }
    
    // ì„ íƒ ì •ë³´ ìˆ¨ê¸°ê¸°
    function hideSelectionInfo() {
        selectionInfo.style.display = 'none';
        selectedText = '';
        selectionStart = 0;
        selectionEnd = 0;
        
        // ìƒì„¸ ì •ë³´ íŒ¨ë„ ì´ˆê¸°í™”
        document.getElementById('selectedText').value = '';
        document.getElementById('entityType').value = '';
    }
    
    // íƒœê·¸ í™•ì¸ ë²„íŠ¼
    confirmTagBtn.addEventListener('click', function() {
        if (!selectedTagType || !selectedText) {
            alert('íƒœê·¸ íƒ€ì…ê³¼ í…ìŠ¤íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        
        // íƒœê·¸ ì¶”ê°€ API í˜¸ì¶œ
        addPiiTag(selectedTagType, selectedText, selectionStart, selectionEnd);
    });
    
    // íƒœê·¸ ì·¨ì†Œ ë²„íŠ¼
    cancelTagBtn.addEventListener('click', function() {
        hideSelectionInfo();
        clearSelection();
        clearTagHighlights();
    });
    
    // ì„ íƒ ì´ˆê¸°í™”
    function clearSelection() {
        // ëª¨ë“  íƒœê·¸ ë²„íŠ¼ì—ì„œ selected í´ë˜ìŠ¤ ì œê±°
        tagButtons.forEach(btn => btn.classList.remove('selected'));
        selectedTagType = null;
        
        // ëª¨ë“  ê¸°ì¡´ íƒœê·¸ì—ì„œ selected í´ë˜ìŠ¤ ì œê±°
        document.querySelectorAll('.existing-pii-tag').forEach(tag => {
            tag.classList.remove('selected');
        });
        
        // ë¬¸ì„œ í…ìŠ¤íŠ¸ ì»¤ì„œ ì›ë˜ëŒ€ë¡œ
        documentText.style.cursor = 'text';
        documentText.title = '';
        
        // í…ìŠ¤íŠ¸ ì„ íƒ í•´ì œ
        window.getSelection().removeAllRanges();
        
        // ë§í¬ ìŠ¤íƒ€ì¼ ì¬ì ìš©ìœ¼ë¡œ í™”ë©´ ì—…ë°ì´íŠ¸
        if (typeof applyLinkedTagStyles === 'function') {
            applyLinkedTagStyles();
        }
        
        // ì„ íƒëœ í…ìŠ¤íŠ¸ ì •ë³´ ì´ˆê¸°í™”
        selectedText = '';
        selectionStart = 0;
        selectionEnd = 0;
        
        // ìƒì„¸ ì •ë³´ íŒ¨ë„ ì´ˆê¸°í™”
        document.getElementById('selectedText').value = '';
        document.getElementById('entityType').value = '';
        document.getElementById('jsonDisplay').value = '';
    }
    
    // PII íƒœê·¸ ì¶”ê°€ í•¨ìˆ˜
    function addPiiTag(tagType, text, start, end) {
        const formData = new FormData();
        formData.append('document_id', {{ document.id }});
        formData.append('pii_category_value', tagType);
        formData.append('span_text', text);
        formData.append('start_offset', start);
        formData.append('end_offset', end);
        formData.append('span_id', '');
        formData.append('entity_id', '');
        formData.append('annotator', '{{ user.username }}');
        formData.append('identifier_type', '');
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch('{% url "add_pii_tag" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // ì„±ê³µ ì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                location.reload();
            } else {
                alert('íƒœê·¸ ì¶”ê°€ ì‹¤íŒ¨: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .finally(() => {
            hideSelectionInfo();
            clearSelection();
        });
    }
    
    // ESC í‚¤ë¡œ ì„ íƒ ì·¨ì†Œ
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideSelectionInfo();
            clearSelection();
        }
    });
    
    // ì „ì—­ íƒœê·¸ ì‚­ì œ í•¨ìˆ˜
    window.deleteTag = function(tagId) {
        if (confirm('ì´ íƒœê·¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            const formData = new FormData();
            formData.append('tag_id', tagId);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            fetch('{% url "delete_pii_tag" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ì„±ê³µ ì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                    location.reload();
                } else {
                    alert('íƒœê·¸ ì‚­ì œ ì‹¤íŒ¨: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }
    };
    
    // ê¸°ì¡´ íƒœê·¸ ì„ íƒ í•¨ìˆ˜
    window.selectExistingTag = function(tagId) {
        const tagElement = document.querySelector(`[data-tag-id="${tagId}"]`);
        if (tagElement) {
            const tagData = JSON.parse(tagElement.dataset.tagData);
            console.log("tagdata: ", tagData);
            
            // ìƒì„¸ ì •ë³´ íŒ¨ë„ ì—…ë°ì´íŠ¸
            document.getElementById('selectedText').value = tagData.text;
            document.getElementById('entityType').value = tagData.category;
            document.getElementById('annotator').value = tagData.annotator || 'Anonymous';
            document.getElementById('identifierType').value = tagData.identifier_type || 'default';
            
            
            // ì—°ê²° ë“œë¡­ë°•ìŠ¤ ì—…ë°ì´íŠ¸
            updateLinkedAnnotationDropdown(tagId);
            // í˜„ì¬ íƒœê·¸ì˜ entity_idì— ë§ê²Œ ë“œë¡­ë°•ìŠ¤ ì„ íƒê°’ ì„¤ì •
            const linkedDropdown = document.getElementById('linkedAnnotation');
            if (String(tagData.entity_id) === String(tagData.span_id)) {
                // ìê¸° ìì‹ ì˜ ëŒ€í‘œ idë©´ ë…ë¦½ ì–´ë…¸í…Œì´ì…˜ ì„ íƒ
                linkedDropdown.value = '';
            } else {
                // ë‹¤ë¥¸ ê·¸ë£¹ì´ë©´ í•´ë‹¹ entity_id ì„ íƒ (ì˜µì…˜ì´ ì—†ëŠ” ê²½ìš° ëŒ€ë¹„)
                const hasOption = Array.from(linkedDropdown.options).some(opt => String(opt.value) === String(tagData.entity_id));
                linkedDropdown.value = hasOption ? String(tagData.entity_id) : '';
            }
            
            // JSON ì •ë³´ ìƒì„±
            const jsonData = {
                span_text: tagData.text,
                entity_type: tagData.category,
                start_offset: tagData.start,
                end_offset: tagData.end,
                span_id: tagData.span_id,
                entity_id: tagData.entity_id,
                annotator: tagData.annotator || "Anonymous",
                identifier_type: tagData.identifier_type || 'default'
            };
            
            document.getElementById('jsonDisplay').value = JSON.stringify(jsonData, null, 2);
            
            // ë©”íƒ€ë°ì´í„° í‘œì‹œ
            const metadata = {
                data_id: "{{ document.data_id }}",
                number_of_subjects: {{ document.number_of_subjects|default:0 }},
                provenance: {
                    dialog_type: "{{ document.dialog_type|default:'' }}",
                    turn_cnt: {{ document.turn_cnt|default:0 }},
                    doc_id: "{{ document.doc_id|default:'' }}"
                }
            };
            
            document.getElementById('metadata').value = JSON.stringify(metadata, null, 2);
            
            // ëª¨ë“  íƒœê·¸ì—ì„œ ì„ íƒ ìƒíƒœ ì œê±°
            document.querySelectorAll('.existing-pii-tag').forEach(tag => {
                tag.classList.remove('selected');
            });
            
            // ì„ íƒëœ íƒœê·¸ì— ì„ íƒ ìƒíƒœ ì¶”ê°€
            tagElement.classList.add('selected');
            
            // ì—°ê²°ëœ íƒœê·¸ë“¤ë„ í•¨ê»˜ í•˜ì´ë¼ì´íŠ¸
            highlightLinkedTags(tagData.entity_id);
            applyLinkedTagStyles();

            
            // í˜„ì¬ íƒœê·¸ íƒ€ì…ì— í•´ë‹¹í•˜ëŠ” ë²„íŠ¼ ì„ íƒ
            const correspondingButton = document.querySelector(`[data-tag-type="${tagData.category}"]`);
            if (correspondingButton) {
                // ëª¨ë“  íƒœê·¸ ë²„íŠ¼ì—ì„œ selected í´ë˜ìŠ¤ ì œê±°
                document.querySelectorAll('.pii-tag-btn').forEach(btn => btn.classList.remove('selected'));
                // í•´ë‹¹ ë²„íŠ¼ì— selected í´ë˜ìŠ¤ ì¶”ê°€
                correspondingButton.classList.add('selected');
                selectedTagType = tagData.category;
            }
        }
    };
    
    // ê¸°ì¡´ íƒœê·¸ íƒ€ì… ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateExistingTagType(tagElement, newType) {
        const tagId = tagElement.dataset.tagId;
        const tagData = JSON.parse(tagElement.dataset.tagData);
        const identifierType = tagData.identifier_type || 'default';
        
        const formData = new FormData();
        formData.append('tag_id', tagId);
        formData.append('pii_category_value', newType);
        formData.append('identifier_type', identifierType);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        fetch('{% url "update_pii_tag" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log("data: ", data);
                // íƒœê·¸ ìš”ì†Œ ì—…ë°ì´íŠ¸
                tagElement.style.backgroundColor = data.new_color;
                tagElement.title = `${data.new_category}: ${tagElement.textContent}`;
                
                // ìƒì„¸ ì •ë³´ íŒ¨ë„ ì—…ë°ì´íŠ¸
                document.getElementById('entityType').value = data.new_category;
                document.getElementById('annotator').value = "{{ user.username }}";  // ì–´ë…¸í…Œì´í„° ì—…ë°ì´íŠ¸
                
                // JSON ì •ë³´ ì—…ë°ì´íŠ¸
                
                const jsonData = {
                    span_text: tagData.text,
                    entity_type: data.new_category,
                    start_offset: tagData.start,
                    end_offset: tagData.end,
                    span_id: tagData.span_id,
                    entity_id: tagData.entity_id,
                    annotator: "{{ user.username }}",
                    identifier_type: identifierType
                };
                
                document.getElementById('jsonDisplay').value = JSON.stringify(jsonData, null, 2);
                
                // íƒœê·¸ ë°ì´í„° ì—…ë°ì´íŠ¸
                tagData.category = data.new_category;
                tagData.annotator = "{{ user.username }}";  // ë¡œì»¬ ë°ì´í„°ë„ ì—…ë°ì´íŠ¸
                tagElement.dataset.tagData = JSON.stringify(tagData);
                
                // ë§í¬ ìŠ¤íƒ€ì¼ ì¬ì ìš©
                applyLinkedTagStyles();
                
                console.log('íƒœê·¸ íƒ€ì…ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤:', data.new_category);
            } else {
                alert('íƒœê·¸ íƒ€ì… ë³€ê²½ ì‹¤íŒ¨: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }
    
    // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ë¡œ ë¬¸ì„œ ë„¤ë¹„ê²Œì´ì…˜
    document.addEventListener('keydown', function(e) {
        // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤ê°€ ìˆëŠ” ê²½ìš° ë‹¨ì¶•í‚¤ ë¹„í™œì„±í™”
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
            return;
        }
        
        // Ctrl + â† : ì´ì „ ë¬¸ì„œ
        if (e.ctrlKey && e.key === 'ArrowLeft') {
            e.preventDefault();
            {% if prev_document %}
            window.location.href = "{% url 'document_detail' prev_document.pk %}";
            {% endif %}
        }
        
        // Ctrl + â†’ : ë‹¤ìŒ ë¬¸ì„œ
        if (e.ctrlKey && e.key === 'ArrowRight') {
            e.preventDefault();
            {% if next_document %}
            window.location.href = "{% url 'document_detail' next_document.pk %}";
            {% endif %}
        }
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë©”íƒ€ë°ì´í„° ì´ˆê¸° í‘œì‹œ
    document.addEventListener('DOMContentLoaded', function() {
        const metadata = {
            data_id: "{{ document.data_id }}",
            number_of_subjects: {{ document.number_of_subjects|default:0 }},
            provenance: {
                dialog_type: "{{ document.dialog_type|default:'' }}",
                turn_cnt: {{ document.turn_cnt|default:0 }},
                doc_id: "{{ document.doc_id|default:'' }}"
            }
        };
        
        document.getElementById('metadata').value = JSON.stringify(metadata, null, 2);
    });
});
</script>
{% endblock %}