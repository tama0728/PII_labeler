{% extends 'main/base.html' %}

{% block title %}{{ document.data_id }} - PII Labeler{% endblock %}

{% block extra_css %}
<style>
.pii-tag-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 20px;
    padding: 12px;
    background-color: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.pii-tag-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 15px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.2s ease;
    position: relative;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    min-width: 80px;
}

.pii-tag-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.pii-tag-btn.selected {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    border: 2px solid #fff;
}

.pii-tag-btn.selected::after {
    content: '✓';
    position: absolute;
    top: -5px;
    right: -5px;
    background: #28a745;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid white;
}

.document-text {
    position: relative;
    line-height: 1.8;
    font-size: 16px;
    padding: 20px;
    background-color: white;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    user-select: text;
    cursor: text;
    font-family: 'Courier New', monospace;
}

.document-text::selection {
    background-color: rgba(0, 123, 255, 0.3);
}

.text-selection-overlay {
    position: absolute;
    background-color: rgba(0, 123, 255, 0.2);
    border: 2px solid #007bff;
    border-radius: 4px;
    pointer-events: none;
    z-index: 10;
}

.selection-info {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    z-index: 1000;
    display: none;
    min-width: 300px;
}

.selection-info h6 {
    margin-bottom: 15px;
    color: #333;
}

.selection-info .selected-text {
    background-color: #f8f9fa;
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 15px;
    border-left: 4px solid #007bff;
}

.selection-info .btn-group {
    display: flex;
    gap: 10px;
}

.selection-info .btn {
    flex: 1;
}

.tag-instruction {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    text-align: center;
}

.tag-instruction .step {
    display: inline-block;
    margin: 0 10px;
    padding: 8px 16px;
    background: rgba(255,255,255,0.2);
    border-radius: 20px;
    font-size: 14px;
}

.tag-instruction .arrow {
    font-size: 18px;
    margin: 0 5px;
}

.existing-pii-tag {
    display: inline-block;
    padding: 2px 6px;
    margin: 1px;
    border-radius: 4px;
    color: white;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.existing-pii-tag:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

@media (max-width: 768px) {
    .pii-tag-buttons {
        flex-direction: column;
    }
    
    .pii-tag-btn {
        width: 100%;
        text-align: center;
    }
    
    .tag-instruction .step {
        display: block;
        margin: 5px 0;
    }
    
    .tag-instruction .arrow {
        display: none;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">{{ document.data_id }}</h4>
                <div>
                    <span class="badge bg-secondary">{{ document.created_at|date:"Y-m-d H:i" }}</span>
                    <span class="badge bg-info">{{ pii_tags.count }} PII 태그</span>
                </div>
            </div>
            <div class="card-body">
                <!-- 태그 추가 안내 -->
                <div class="tag-instruction">
                    <div class="step">1. 태그 타입 선택</div>
                    <span class="arrow">→</span>
                    <div class="step">2. 텍스트 드래그</div>
                    <span class="arrow">→</span>
                    <div class="step">3. 태그 추가</div>
                </div>

                <!-- PII 태그 버튼들 -->
                <div class="pii-tag-buttons">
                    {% for category in pii_categories %}
                    <button class="pii-tag-btn" 
                            data-tag-type="{{ category.value }}"
                            style="background-color: {{ category.background_color }};"
                            title="{{ category.description }}">
                        {{ category.value }}
                        <small class="d-block" style="font-size: 10px; opacity: 0.9;">{{ category.description|truncatechars:15 }}</small>
                    </button>
                    {% endfor %}
                </div>

                <!-- 문서 텍스트 -->
                <div class="document-text" id="document-text" data-original-text="{{ document.text }}">
                    {{ document.text|linebreaks }}
                </div>
                
                <div class="mt-3">
                    <button class="btn btn-secondary" onclick="location.reload()">
                        <i class="fas fa-refresh"></i> 새로고침
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-tags"></i> PII 태그 목록</h5>
            </div>
            <div class="card-body">
                {% if pii_tags %}
                    {% for tag in pii_tags %}
                    <div class="d-flex justify-content-between align-items-start mb-3 p-2 border rounded">
                        <div>
                            <span class="badge" style="background-color: {{ tag.pii_category.background_color }}; color: white;">
                                {{ tag.pii_category.value }}
                            </span>
                            <div class="mt-1">
                                <strong>{{ tag.span_text }}</strong>
                                <small class="text-muted d-block">
                                    위치: {{ tag.start_offset }}-{{ tag.end_offset }}
                                </small>
                            </div>
                            {% if tag.annotator %}
                            <small class="text-muted">
                                작성자: {{ tag.annotator }}
                            </small>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">아직 PII 태그가 없습니다.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 텍스트 선택 확인 모달 -->
<div class="selection-info" id="selection-info">
    <h6><i class="fas fa-tag"></i> PII 태그 추가</h6>
    <div class="selected-text">
        <strong>선택된 태그:</strong> <span id="selected-tag-name"></span><br>
        <strong>선택된 텍스트:</strong> "<span id="selected-text-preview"></span>"<br>
        <small class="text-muted" id="selected-position"></small>
    </div>
    <div class="btn-group">
        <button type="button" class="btn btn-success" id="confirm-tag-btn">
            <i class="fas fa-check"></i> 태그 추가
        </button>
        <button type="button" class="btn btn-secondary" id="cancel-tag-btn">
            <i class="fas fa-times"></i> 취소
        </button>
    </div>
</div>

<!-- CSRF 토큰 -->
{% csrf_token %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let selectedTagType = null;
    let selectedText = '';
    let selectionStart = 0;
    let selectionEnd = 0;
    let isSelecting = false;
    
    // PII 태그 버튼들
    const tagButtons = document.querySelectorAll('.pii-tag-btn');
    const documentText = document.querySelector('.document-text');
    const selectionInfo = document.querySelector('#selection-info');
    const confirmTagBtn = document.querySelector('#confirm-tag-btn');
    const cancelTagBtn = document.querySelector('#cancel-tag-btn');
    
    // 기존 PII 태그들 렌더링
    function renderExistingTags() {
        const originalText = documentText.dataset.originalText;
        let htmlContent = originalText;
        
        // PII 태그들을 시작 위치 기준으로 정렬
        const sortedTags = [
            {% for tag in pii_tags %}
            {
                start: {{ tag.start_offset }},
                end: {{ tag.end_offset }},
                text: "{{ tag.span_text|escapejs }}",
                color: "{{ tag.pii_category.background_color }}",
                category: "{{ tag.pii_category.value }}"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ].sort((a, b) => a.start - b.start);
        
        // 뒤에서부터 태그를 삽입 (인덱스 변화 방지)
        for (let i = sortedTags.length - 1; i >= 0; i--) {
            const tag = sortedTags[i];
            const beforeTag = htmlContent.substring(0, tag.start);
            const afterTag = htmlContent.substring(tag.end);
            const tagHtml = `<span class="existing-pii-tag" style="background-color: ${tag.color};" title="${tag.category}: ${tag.text}">${tag.text}</span>`;
            htmlContent = beforeTag + tagHtml + afterTag;
        }
        
        // 줄바꿈 처리
        htmlContent = htmlContent.replace(/\n/g, '<br>');
        documentText.innerHTML = htmlContent;
    }
    
    // 페이지 로드 시 기존 태그들 렌더링
    renderExistingTags();
    
    // 태그 버튼 클릭 처리
    tagButtons.forEach(button => {
        button.addEventListener('click', function() {
            // 모든 버튼에서 selected 클래스 제거
            tagButtons.forEach(btn => btn.classList.remove('selected'));
            
            // 클릭된 버튼에 selected 클래스 추가
            this.classList.add('selected');
            selectedTagType = this.dataset.tagType;
            
            // 문서 텍스트에 선택 가능 상태 표시
            documentText.style.cursor = 'crosshair';
            documentText.title = '텍스트를 드래그하여 선택하세요';
            
            console.log('선택된 태그 타입:', selectedTagType);
        });
    });
    
    // 텍스트 선택 시작
    documentText.addEventListener('mousedown', function(e) {
        if (!selectedTagType) return;
        
        isSelecting = true;
        documentText.style.userSelect = 'text';
        
        // 기존 선택 정보 숨기기
        hideSelectionInfo();
    });
    
    // 텍스트 선택 중
    documentText.addEventListener('mouseup', function(e) {
        if (!selectedTagType || !isSelecting) return;
        
        setTimeout(() => {
            const selection = window.getSelection();
            const text = selection.toString().trim();
            
            if (text && text.length > 0) {
                selectedText = text;
                
                // 선택된 텍스트의 원본 텍스트에서의 위치 계산
                const originalText = documentText.dataset.originalText;
                
                // 선택된 텍스트를 원본 텍스트에서 찾기
                let startOffset = -1;
                let endOffset = -1;
                
                // 원본 텍스트에서 정확히 일치하는 텍스트 찾기
                const textIndex = originalText.indexOf(text);
                if (textIndex !== -1) {
                    startOffset = textIndex;
                    endOffset = textIndex + text.length;
                } else {
                    // 부분 매칭으로 찾기 (공백 제거 후 비교)
                    const cleanText = text.replace(/\s+/g, '');
                    const cleanOriginal = originalText.replace(/\s+/g, '');
                    const cleanIndex = cleanOriginal.indexOf(cleanText);
                    
                    if (cleanIndex !== -1) {
                        // 원본 텍스트에서 해당 위치 찾기
                        let originalIndex = 0;
                        let cleanIndexCount = 0;
                        
                        for (let i = 0; i < originalText.length; i++) {
                            if (!/\s/.test(originalText[i])) {
                                if (cleanIndexCount === cleanIndex) {
                                    startOffset = i;
                                    break;
                                }
                                cleanIndexCount++;
                            }
                            originalIndex++;
                        }
                        
                        if (startOffset !== -1) {
                            endOffset = startOffset + text.replace(/\s+/g, '').length;
                        }
                    }
                }
                
                if (startOffset !== -1 && endOffset !== -1) {
                    selectionStart = startOffset;
                    selectionEnd = endOffset;
                    showSelectionInfo(text, startOffset, endOffset);
                } else {
                    alert('선택된 텍스트를 원본 문서에서 찾을 수 없습니다.');
                }
            }
        }, 10);
        
        isSelecting = false;
    });
    
    // 선택 정보 표시
    function showSelectionInfo(text, start, end) {
        const selectedTagButton = document.querySelector('.pii-tag-btn.selected');
        const tagName = selectedTagButton ? selectedTagButton.textContent.split('\n')[0] : 'Unknown';
        
        document.querySelector('#selected-tag-name').textContent = tagName;
        document.querySelector('#selected-text-preview').textContent = text;
        document.querySelector('#selected-position').textContent = `위치: ${start}-${end}`;
        
        selectionInfo.style.display = 'block';
    }
    
    // 선택 정보 숨기기
    function hideSelectionInfo() {
        selectionInfo.style.display = 'none';
        selectedText = '';
        selectionStart = 0;
        selectionEnd = 0;
    }
    
    // 태그 확인 버튼
    confirmTagBtn.addEventListener('click', function() {
        if (!selectedTagType || !selectedText) {
            alert('태그 타입과 텍스트를 선택해주세요.');
            return;
        }
        
        // 태그 추가 API 호출
        addPiiTag(selectedTagType, selectedText, selectionStart, selectionEnd);
    });
    
    // 태그 취소 버튼
    cancelTagBtn.addEventListener('click', function() {
        hideSelectionInfo();
        clearSelection();
    });
    
    // 선택 초기화
    function clearSelection() {
        // 모든 태그 버튼에서 selected 클래스 제거
        tagButtons.forEach(btn => btn.classList.remove('selected'));
        selectedTagType = null;
        
        // 문서 텍스트 커서 원래대로
        documentText.style.cursor = 'text';
        documentText.title = '';
        
        // 텍스트 선택 해제
        window.getSelection().removeAllRanges();
    }
    
    // PII 태그 추가 함수
    function addPiiTag(tagType, text, start, end) {
        const formData = new FormData();
        formData.append('document_id', {{ document.id }});
        formData.append('pii_category_value', tagType);
        formData.append('span_text', text);
        formData.append('start_offset', start);
        formData.append('end_offset', end);
        formData.append('span_id', '');
        formData.append('entity_id', '');
        formData.append('annotator', '{{ user.username }}');
        formData.append('identifier_type', '');
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch('{% url "add_pii_tag" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 성공 시 페이지 새로고침
                location.reload();
            } else {
                alert('태그 추가 실패: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('오류가 발생했습니다.');
        })
        .finally(() => {
            hideSelectionInfo();
            clearSelection();
        });
    }
    
    // ESC 키로 선택 취소
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideSelectionInfo();
            clearSelection();
        }
    });
});
</script>
{% endblock %}