{% extends 'main/base.html' %}

{% block title %}{{ document.title }} - PII Labeler{% endblock %}

{% block extra_css %}
<style>
    .pii-tag {
        background-color: #ffeb3b;
        padding: 2px 4px;
        border-radius: 3px;
        cursor: pointer;
        position: relative;
        display: inline-block;
    }
    .pii-tag:hover {
        background-color: #ffc107;
    }
    .pii-tag.name { background-color: #e3f2fd; }
    .pii-tag.email { background-color: #f3e5f5; }
    .pii-tag.phone { background-color: #e8f5e8; }
    .pii-tag.address { background-color: #fff3e0; }
    .pii-tag.ssn { background-color: #ffebee; }
    .pii-tag.credit_card { background-color: #f1f8e9; }
    
    .tag-info {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
        z-index: 1000;
    }
    .pii-tag:hover .tag-info {
        opacity: 1;
    }
    
    .document-content {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        background-color: #f8f9fa;
        font-family: 'Courier New', monospace;
        line-height: 1.6;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">{{ document.title }}</h4>
                <div>
                    <span class="badge bg-secondary">{{ document.created_at|date:"Y-m-d H:i" }}</span>
                    <span class="badge bg-info">{{ pii_tags.count }} PII 태그</span>
                </div>
            </div>
            <div class="card-body">
                <div class="document-content" id="document-content">
                    {{ document.content|linebreaks }}
                </div>
                
                <div class="mt-3">
                    <button class="btn btn-primary" id="add-pii-tag-btn">
                        <i class="fas fa-plus"></i> PII 태그 추가
                    </button>
                    <button class="btn btn-secondary" onclick="location.reload()">
                        <i class="fas fa-refresh"></i> 새로고침
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-tags"></i> PII 태그 목록</h5>
            </div>
            <div class="card-body">
                {% if pii_tags %}
                    {% for tag in pii_tags %}
                    <div class="d-flex justify-content-between align-items-start mb-3 p-2 border rounded">
                        <div>
                            <span class="badge bg-primary">{{ tag.get_pii_type_display }}</span>
                            <div class="mt-1">
                                <strong>{{ tag.tagged_text }}</strong>
                            </div>
                            <small class="text-muted">
                                신뢰도: {{ tag.confidence|floatformat:2 }}
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">아직 PII 태그가 없습니다.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- PII 태그 추가 모달 -->
<div class="modal fade" id="piiTagModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">PII 태그 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="pii-tag-form">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">PII 유형</label>
                        <select class="form-select" id="pii-type" required>
                            <option value="">선택하세요</option>
                            <option value="name">이름</option>
                            <option value="email">이메일</option>
                            <option value="phone">전화번호</option>
                            <option value="address">주소</option>
                            <option value="ssn">주민등록번호</option>
                            <option value="credit_card">신용카드번호</option>
                            <option value="other">기타</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">태그할 텍스트</label>
                        <input type="text" class="form-control" id="tagged-text" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">신뢰도 (0.0 - 1.0)</label>
                        <input type="number" class="form-control" id="confidence" min="0" max="1" step="0.1" value="0.8">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" id="save-pii-tag">저장</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = new bootstrap.Modal(document.getElementById('piiTagModal'));
    const addBtn = document.getElementById('add-pii-tag-btn');
    const saveBtn = document.getElementById('save-pii-tag');
    
    addBtn.addEventListener('click', function() {
        modal.show();
    });
    
    saveBtn.addEventListener('click', function() {
        const piiType = document.getElementById('pii-type').value;
        const taggedText = document.getElementById('tagged-text').value;
        const confidence = parseFloat(document.getElementById('confidence').value);
        
        if (!piiType || !taggedText) {
            alert('모든 필드를 입력해주세요.');
            return;
        }
        
        // 간단한 위치 찾기 (실제로는 더 정교한 로직 필요)
        const content = document.getElementById('document-content').textContent;
        const startPos = content.indexOf(taggedText);
        const endPos = startPos + taggedText.length;
        
        if (startPos === -1) {
            alert('문서에서 해당 텍스트를 찾을 수 없습니다.');
            return;
        }
        
        const data = {
            document_id: {{ document.pk }},
            pii_type: piiType,
            start_position: startPos,
            end_position: endPos,
            tagged_text: taggedText,
            confidence: confidence
        };
        
        fetch('{% url "add_pii_tag" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('PII 태그가 추가되었습니다.');
                location.reload();
            } else {
                alert('오류: ' + result.message);
            }
        })
        .catch(error => {
            alert('오류가 발생했습니다: ' + error);
        });
        
        modal.hide();
    });
});
</script>
{% endblock %}
