{% extends 'main/base.html' %}

{% block title %}{{ document.data_id }} - PII Labeler{% endblock %}

{% block extra_css %}
<style>
.pii-tag-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 20px;
    padding: 12px;
    background-color: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.pii-tag-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 15px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.2s ease;
    position: relative;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    min-width: 80px;
}

.pii-tag-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.pii-tag-btn.selected {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    border: 2px solid #fff;
}

.pii-tag-btn.selected::after {
    content: '✓';
    position: absolute;
    top: -5px;
    right: -5px;
    background: #28a745;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid white;
}

.document-text {
    position: relative;
    line-height: 1.8;
    font-size: 16px;
    padding: 20px;
    background-color: white;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    user-select: text;
    cursor: text;
    font-family: 'Courier New', monospace;
}

.document-text::selection {
    background-color: rgba(0, 123, 255, 0.3);
}

.text-selection-overlay {
    position: absolute;
    background-color: rgba(0, 123, 255, 0.2);
    border: 2px solid #007bff;
    border-radius: 4px;
    pointer-events: none;
    z-index: 10;
}

.selection-info {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    z-index: 1000;
    display: none;
    min-width: 300px;
}

.selection-info h6 {
    margin-bottom: 15px;
    color: #333;
}

.selection-info .selected-text {
    background-color: #f8f9fa;
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 15px;
    border-left: 4px solid #007bff;
}

.selection-info .btn-group {
    display: flex;
    gap: 10px;
}

.selection-info .btn {
    flex: 1;
}

.tag-instruction {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    text-align: center;
}

.tag-instruction .step {
    display: inline-block;
    margin: 0 10px;
    padding: 8px 16px;
    background: rgba(255,255,255,0.2);
    border-radius: 20px;
    font-size: 14px;
}

.tag-instruction .arrow {
    font-size: 18px;
    margin: 0 5px;
}

.existing-pii-tag {
    display: inline-block;
    padding: 2px 6px;
    margin: 1px;
    border-radius: 4px;
    color: white;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
}

.existing-pii-tag:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.existing-pii-tag.selected {
    border: 2px solid #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.3);
}

.existing-pii-tag .delete-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    width: 16px;
    height: 16px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 10px;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.existing-pii-tag:hover .delete-btn {
    display: flex;
}

.existing-pii-tag .delete-btn:hover {
    background: #c82333;
    transform: scale(1.1);
}

.entity-details-panel {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    height: fit-content;
    position: sticky;
    top: 20px;
}

.entity-details-panel h3 {
    margin-bottom: 20px;
    color: #333;
    font-size: 18px;
    font-weight: 600;
    border-bottom: 2px solid #007bff;
    padding-bottom: 10px;
}

.entity-details-row {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.entity-details-row .field-group {
    flex: 1;
}

.field-group {
    margin-bottom: 15px;
}

.field-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #555;
    font-size: 13px;
}

.field-group input,
.field-group select,
.field-group textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 13px;
    transition: border-color 0.2s ease;
}

.field-group input:focus,
.field-group select:focus,
.field-group textarea:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
}

.help-text {
    color: #666;
    font-size: 11px;
    margin-top: 5px;
    display: block;
}

@media (max-width: 768px) {
    .pii-tag-buttons {
        flex-direction: column;
    }
    
    .pii-tag-btn {
        width: 100%;
        text-align: center;
    }
    
    .tag-instruction .step {
        display: block;
        margin: 5px 0;
    }
    
    .tag-instruction .arrow {
        display: none;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 문서 헤더 -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <a href="{% url 'document_list' %}" class="btn btn-outline-secondary btn-sm me-3">
                            <i class="fas fa-arrow-left"></i> 목록으로
                        </a>
                        <h4 class="mb-0">{{ document.data_id }}</h4>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <span class="badge bg-light text-dark mx-1">Ctrl + ←, →</span>
                            <span class="text-muted me-2">이전, 다음 문서</span>
                            {% if prev_document %}
                            <a href="{% url 'document_detail' prev_document.pk %}" class="btn btn-outline-primary btn-sm" title="이전 문서: {{ prev_document.data_id }} (Ctrl + ←)">
                                <i class="fas fa-chevron-left"></i> 이전
                                <small class="d-block">{{ prev_document.data_id }}</small>
                            </a>
                            {% else %}
                            <button class="btn btn-outline-secondary btn-sm" disabled title="첫 번째 문서입니다">
                                <i class="fas fa-chevron-left"></i> 이전
                                <small class="d-block">-</small>
                            </button>
                            {% endif %}
                            
                            {% if next_document %}
                            <a href="{% url 'document_detail' next_document.pk %}" class="btn btn-outline-primary btn-sm ms-2" title="다음 문서: {{ next_document.data_id }} (Ctrl + →)">
                                다음 <i class="fas fa-chevron-right"></i>
                                <small class="d-block">{{ next_document.data_id }}</small>
                            </a>
                            {% else %}
                            <button class="btn btn-outline-secondary btn-sm ms-2" disabled title="마지막 문서입니다">
                                다음 <i class="fas fa-chevron-right"></i>
                                <small class="d-block">-</small>
                            </button>
                            {% endif %}
                        </div>
                        <div>
                            <span class="badge bg-secondary">{{ document.created_at|date:"Y-m-d H:i" }}</span>
                            <span class="badge bg-info">{{ pii_tags.count }} PII 태그</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 태그 추가 안내 -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="tag-instruction">
                <div class="step">1. 텍스트 드래그</div>
                <span class="arrow">→</span>
                <div class="step">2. 라벨 선택</div>
                <span class="arrow">→</span>
                <div class="step">3. 태그 추가</div>
            </div>
        </div>
    </div>

    <!-- PII 태그 버튼들 -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="pii-tag-buttons">
                {% for category in pii_categories %}
                <button class="pii-tag-btn" 
                        data-tag-type="{{ category.value }}"
                        style="background-color: {{ category.background_color }};"
                        title="{{ category.description }}">
                    {{ category.value }}
                    <small class="d-block" style="font-size: 10px; opacity: 0.9;">{{ category.description|truncatechars:15 }}</small>
                </button>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- 메인 콘텐츠 영역 -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <!-- 문서 텍스트 -->
                    <div class="document-text" id="document-text" data-original-text="{{ document.text }}">
                        {{ document.text|linebreaks }}
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-secondary" onclick="location.reload()">
                            <i class="fas fa-refresh"></i> 새로고침
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="entity-details-panel">
                <h3>어노테이션 상세 정보</h3>
                
                <div class="entity-details-row">
                    <div class="field-group">
                        <label>선택된 텍스트:</label>
                        <input type="text" id="selectedText" readonly style="background: #f8f9fa; color: #666; border: 1px solid #e8e8e8; padding: 6px 8px; border-radius: 3px; font-size: 12px; width: 100%;">
                    </div>
                    
                    <div class="field-group">
                        <label>엔티티 타입:</label>
                        <input type="text" id="entityType" readonly style="background: #f8f9fa; color: #666; border: 1px solid #e8e8e8; padding: 6px 8px; border-radius: 3px; font-size: 12px; width: 100%;">
                    </div>
                </div>
                
                <div class="auto-generated" style="margin-bottom: 16px;">
                    <label>작업자 (annotator):</label>
                    <input type="text" id="annotator" value="Anonymous" readonly style="width: 100%;">
                </div>
                
                <div class="field-group">
                    <label>식별자 유형 (identifier_type):</label>
                    <select id="identifierType" onchange="updateIdentifierTypeAndSave()">
                        <option value="default">default (마스킹 필요 없음)</option>
                        <option value="direct">직접식별자</option>
                        <option value="quasi">준식별자</option>
                    </select>
                </div>
                
                <div class="field-group">
                    <label>연결된 어노테이션 (entity_id):</label>
                    <select id="linkedAnnotation" onchange="updateEntityIdAndSave()">
                        <option value="">독립 어노테이션</option>
                    </select>
                    <small class="help-text">같은 객체를 나타내는 어노테이션들을 연결합니다.</small>
                </div>
                
                <div class="field-group">
                    <label>JSON 상세 정보:</label>
                    <textarea id="jsonDisplay" style="
                        width: 100%; 
                        height: 200px; 
                        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; 
                        font-size: 12px; 
                        background: #f8f9fa; 
                        border: 1px solid #e8e8e8; 
                        border-radius: 4px; 
                        padding: 12px; 
                        resize: vertical;
                        color: #333;
                        line-height: 1.4;
                    " placeholder="어노테이션을 선택하면 JSON 정보가 표시됩니다."></textarea>
                </div>
                
                <div class="field-group">
                    <label>메타데이터 (metadata):</label>
                    <textarea id="metadata" readonly style="background: #f8f9fa; color: #666; border: 1px solid #e8e8e8; padding: 8px; border-radius: 3px; font-size: 12px; resize: vertical; min-height: 180px; font-family: monospace; width: 100%; box-sizing: border-box;" placeholder="메타데이터가 표시됩니다..."></textarea>
                    <small class="help-text">파일 정보 및 태스크 관련 메타데이터</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 텍스트 선택 확인 모달 -->
<div class="selection-info" id="selection-info">
    <h6><i class="fas fa-tag"></i> PII 태그 추가</h6>
    <div class="selected-text">
        <strong>선택된 태그:</strong> <span id="selected-tag-name"></span><br>
        <strong>선택된 텍스트:</strong> "<span id="selected-text-preview"></span>"<br>
        <small class="text-muted" id="selected-position"></small>
    </div>
    <div class="btn-group">
        <button type="button" class="btn btn-success" id="confirm-tag-btn">
            <i class="fas fa-check"></i> 태그 추가
        </button>
        <button type="button" class="btn btn-secondary" id="cancel-tag-btn">
            <i class="fas fa-times"></i> 취소
        </button>
    </div>
</div>

<!-- CSRF 토큰 -->
{% csrf_token %}
{% endblock %}

{% block extra_js %}
<script>
// 전역 함수들
function updateLinkedAnnotationDropdown(currentTagId) {
    const dropdown = document.getElementById('linkedAnnotation');
    dropdown.innerHTML = '<option value="">독립 어노테이션</option>';

    // 현재 문서의 모든 어노테이션을 엔티티 그룹으로 묶기
    const allTags = Array.from(document.querySelectorAll('.existing-pii-tag')).map(el => JSON.parse(el.dataset.tagData));
    const currentTagData = JSON.parse(document.querySelector(`[data-tag-id="${currentTagId}"]`).dataset.tagData);

    const entityIdToTags = new Map();
    allTags.forEach(tag => {
        if (!entityIdToTags.has(tag.entity_id)) {
            entityIdToTags.set(tag.entity_id, []);
        }
        entityIdToTags.get(tag.entity_id).push(tag);
    });

    // 각 엔티티 그룹의 대표 텍스트: span_id == entity_id 인 태그의 span_text
    entityIdToTags.forEach((tags, entityId) => {
        if (!entityId || tags.some(t => t.id === currentTagId)) {
            // 현재 태그의 그룹도 옵션으로 표시(자기 연결 유지), entityId 비어있으면 스킵
        }
        // 대표 텍스트 선택
        let representativeText = '';
        const rep = tags.find(t => t.span_id && t.entity_id && String(t.span_id) === String(t.entity_id));
        if (rep) {
            representativeText = rep.text;
        } else {
            representativeText = tags[0]?.text || '';
        }

        // 옵션 생성 (값은 entity_id)
        const option = document.createElement('option');
        option.value = entityId;
        option.textContent = `${representativeText}`;
        if (String(entityId) === String(currentTagData.entity_id)) {
            option.selected = true;
        }
        dropdown.appendChild(option);
    });
}

function updateEntityIdAndSave() {
    const dropdown = document.getElementById('linkedAnnotation');
    const selectedEntityId = dropdown.value; // entity_id 값
    const currentTagElement = document.querySelector('.existing-pii-tag.selected');
    
    if (!currentTagElement) {
        console.log('선택된 태그가 없습니다.');
        return;
    }
    
    const currentTagData = JSON.parse(currentTagElement.dataset.tagData);
    let newEntityId = '';
    
    if (!selectedEntityId) {
        // 독립 어노테이션으로 설정 (span_id와 동일)
        newEntityId = currentTagData.span_id;
    } else {
        // 선택된 entity_id 그룹과 연결
        const allTagElements = document.querySelectorAll('.existing-pii-tag');
        const connectedTags = [];
        allTagElements.forEach(tagElement => {
            const tagData = JSON.parse(tagElement.dataset.tagData);
            if (String(tagData.entity_id) === String(selectedEntityId)) {
                connectedTags.push(tagElement);
            }
        });
        
        // 현재 선택된 태그도 추가
        connectedTags.push(currentTagElement);

        // 현재 태그가 대표( span_id == entity_id )였다면,
        // 자신의 span_id에 연결되어 있던 다른 태그들도 같이 연결
        if (String(currentTagData.span_id) === String(currentTagData.entity_id)) {
            allTagElements.forEach(tagElement => {
                const tagData = JSON.parse(tagElement.dataset.tagData);
                if (String(tagData.entity_id) === String(currentTagData.span_id)) {
                    // 중복 추가 방지
                    if (!connectedTags.includes(tagElement)) {
                        connectedTags.push(tagElement);
                    }
                }
            });
        }
        
        // 가장 작은 span_id를 entity_id로 사용
        const minSpanId = Math.min(...connectedTags.map(tag => {
            const data = JSON.parse(tag.dataset.tagData);
            return parseInt(data.span_id) || 0;
        }));
        
        newEntityId = minSpanId.toString();
        
        // 모든 연결된 태그의 entity_id 업데이트 및 서버 저장
        connectedTags.forEach(tagElement => {
            updateTagEntityId(tagElement, newEntityId);
        });
    }
    
    // 현재 태그의 entity_id 업데이트
    updateTagEntityId(currentTagElement, newEntityId);
    
    // 서버에 저장
    // 1) 현재 태그 저장
    saveTagUpdate(currentTagData.id, currentTagData.category, document.getElementById('identifierType').value, newEntityId);
    // 2) 대표 이동 시 함께 연결된 태그들도 저장
    if (selectedEntityId) {
        const allTagElements = document.querySelectorAll('.existing-pii-tag');
        allTagElements.forEach(tagElement => {
            const data = JSON.parse(tagElement.dataset.tagData);
            if (String(data.entity_id) === String(newEntityId) && data.id !== currentTagData.id) {
                const idType = data.identifier_type || document.getElementById('identifierType').value || 'default';
                saveTagUpdate(data.id, data.category, idType, newEntityId);
            }
        });
    }
}

function updateIdentifierTypeAndSave() {
    const currentTagElement = document.querySelector('.existing-pii-tag.selected');
    
    if (!currentTagElement) {
        console.log('선택된 태그가 없습니다.');
        return;
    }
    
    const currentTagData = JSON.parse(currentTagElement.dataset.tagData);
    const identifierType = document.getElementById('identifierType').value || 'default';
    
    // 서버에 저장
    saveTagUpdate(currentTagData.id, currentTagData.category, identifierType, currentTagData.entity_id);
}

function saveTagUpdate(tagId, piiCategoryValue, identifierType, entityId) {
    const formData = new FormData();
    formData.append('tag_id', tagId);
    formData.append('pii_category_value', piiCategoryValue);
    formData.append('identifier_type', identifierType);
    formData.append('entity_id', entityId);
    
    fetch('{% url "update_pii_tag" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('태그가 성공적으로 업데이트되었습니다.');
            // JSON 표시 업데이트
            updateJsonDisplay();

            // 로컬 데이터 동기화: identifier_type, entity_id 반영
            const tagElement = document.querySelector(`[data-tag-id="${tagId}"]`);
            if (tagElement) {
                const localData = JSON.parse(tagElement.dataset.tagData);
                localData.identifier_type = identifierType || 'default';
                if (entityId) {
                    localData.entity_id = entityId;
                }
                tagElement.dataset.tagData = JSON.stringify(localData);

                // 현재 선택된 태그라면 드롭박스 값도 갱신
                if (tagElement.classList.contains('selected')) {
                    const identifierSelect = document.getElementById('identifierType');
                    if (identifierSelect) identifierSelect.value = localData.identifier_type || 'default';
                }
            }
        } else {
            console.error('태그 업데이트 실패:', data.message);
        }
    })
    .catch(error => {
        console.error('태그 업데이트 중 오류 발생:', error);
    });
}

function updateTagEntityId(tagElement, newEntityId) {
    const tagData = JSON.parse(tagElement.dataset.tagData);
    tagData.entity_id = newEntityId;
    tagElement.dataset.tagData = JSON.stringify(tagData);
    
    // JSON 표시 업데이트
    updateJsonDisplay();
}

function updateCurrentTagEntityId(newEntityId) {
    const currentTagElement = document.querySelector('.existing-pii-tag.selected');
    if (currentTagElement) {
        const tagData = JSON.parse(currentTagElement.dataset.tagData);
        if (newEntityId) {
            tagData.entity_id = newEntityId;
        } else {
            // 독립 어노테이션으로 설정 (span_id와 동일)
            tagData.entity_id = tagData.span_id;
        }
        currentTagElement.dataset.tagData = JSON.stringify(tagData);
        updateJsonDisplay();
    }
}

function updateJsonDisplay() {
    const currentTagElement = document.querySelector('.existing-pii-tag.selected');
    if (currentTagElement) {
        const tagData = JSON.parse(currentTagElement.dataset.tagData);
        const jsonData = {
            span_text: tagData.text,
            entity_type: tagData.category,
            start_offset: tagData.start,
            end_offset: tagData.end,
            span_id: tagData.span_id,
            entity_id: tagData.entity_id,
            annotator: tagData.annotator || "Anonymous",
            identifier_type: tagData.identifier_type || 'default'
        };
        
        document.getElementById('jsonDisplay').value = JSON.stringify(jsonData, null, 2);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    let selectedTagType = null;
    let selectedText = '';
    let selectionStart = 0;
    let selectionEnd = 0;
    let isSelecting = false;
    
    // PII 태그 버튼들
    const tagButtons = document.querySelectorAll('.pii-tag-btn');
    const documentText = document.querySelector('.document-text');
    const selectionInfo = document.querySelector('#selection-info');
    const confirmTagBtn = document.querySelector('#confirm-tag-btn');
    const cancelTagBtn = document.querySelector('#cancel-tag-btn');
    
    // 기존 PII 태그들 렌더링
    function renderExistingTags() {
        const originalText = documentText.dataset.originalText;
        let htmlContent = originalText;
        
        // PII 태그들을 시작 위치 기준으로 정렬
        const sortedTags = [
            {% for tag in pii_tags %}
            {
                id: {{ tag.id }},
                start: {{ tag.start_offset }},
                end: {{ tag.end_offset }},
                text: "{{ tag.span_text|escapejs }}",
                color: "{{ tag.pii_category.background_color }}",
                category: "{{ tag.pii_category.value }}",
                span_id: "{{ tag.span_id|escapejs }}",
                entity_id: "{{ tag.entity_id|escapejs }}",
                annotator: "{{ tag.annotator|escapejs }}",
                identifier_type: "{{ tag.identifier_type|escapejs }}"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ].sort((a, b) => a.start - b.start);
        
        // 뒤에서부터 태그를 삽입 (인덱스 변화 방지)
        for (let i = sortedTags.length - 1; i >= 0; i--) {
            const tag = sortedTags[i];
            const beforeTag = htmlContent.substring(0, tag.start);
            const afterTag = htmlContent.substring(tag.end);
            const tagHtml = `<span class="existing-pii-tag" style="background-color: ${tag.color};" title="${tag.category}: ${tag.text}" data-tag-id="${tag.id}" data-tag-data='${JSON.stringify(tag)}' onclick="selectExistingTag(${tag.id})">${tag.text}<button class="delete-btn" onclick="deleteTag(${tag.id}); event.stopPropagation();" title="태그 삭제">×</button></span>`;
            htmlContent = beforeTag + tagHtml + afterTag;
        }
        
        // 줄바꿈 처리
        htmlContent = htmlContent.replace(/\n/g, '<br>');
        documentText.innerHTML = htmlContent;
    }
    
    // 페이지 로드 시 기존 태그들 렌더링
    renderExistingTags();
    
    // 태그 버튼 클릭 처리
    tagButtons.forEach(button => {
        button.addEventListener('click', function() {
            // 현재 선택된 태그가 있는지 확인
            const selectedTag = document.querySelector('.existing-pii-tag.selected');
            if (selectedTag) {
                // 기존 태그의 타입을 변경
                const newTagType = this.dataset.tagType;
                updateExistingTagType(selectedTag, newTagType);
                
                // 모든 버튼에서 selected 클래스 제거
                tagButtons.forEach(btn => btn.classList.remove('selected'));
                // 클릭된 버튼에 selected 클래스 추가
                this.classList.add('selected');
                selectedTagType = newTagType;
            } else if (selectedText && selectedText.length > 0) {
                // 텍스트가 선택된 상태에서 라벨 선택
                const newTagType = this.dataset.tagType;
                
                // 모든 버튼에서 selected 클래스 제거
                tagButtons.forEach(btn => btn.classList.remove('selected'));
                // 클릭된 버튼에 selected 클래스 추가
                this.classList.add('selected');
                selectedTagType = newTagType;
                
                // 선택 정보 표시
                showSelectionInfo(selectedText, selectionStart, selectionEnd);
            } else {
                // 아무것도 선택되지 않은 상태에서는 선택 불가
                // 조용히 무시 (알림 메시지 제거)
            }
        });
    });
    
    // 텍스트 선택 시작
    documentText.addEventListener('mousedown', function(e) {
        isSelecting = true;
        documentText.style.userSelect = 'text';

        // 기존 선택 정보 숨기기
        hideSelectionInfo();
    });
    
    // 텍스트 선택 중
    documentText.addEventListener('mouseup', function(e) {
        if (!isSelecting) return;
        
        setTimeout(() => {
            const selection = window.getSelection();
            const text = selection.toString().trim();
            
            if (text && text.length > 0) {
                // 모든 태그 버튼에서 selected 클래스 제거
                tagButtons.forEach(btn => btn.classList.remove('selected'));
                selectedTagType = null;
                
                // 모든 기존 태그에서 selected 클래스 제거
                document.querySelectorAll('.existing-pii-tag').forEach(tag => {
                    tag.classList.remove('selected');
                });
                selectedText = text;
                
                // 선택된 텍스트의 원본 텍스트에서의 위치 계산
                const originalText = documentText.dataset.originalText;
                
                // 선택된 텍스트를 원본 텍스트에서 찾기
                let startOffset = -1;
                let endOffset = -1;
                
                // 원본 텍스트에서 정확히 일치하는 텍스트 찾기
                const textIndex = originalText.indexOf(text);
                if (textIndex !== -1) {
                    startOffset = textIndex;
                    endOffset = textIndex + text.length;
                } else {
                    // 부분 매칭으로 찾기 (공백 제거 후 비교)
                    const cleanText = text.replace(/\s+/g, '');
                    const cleanOriginal = originalText.replace(/\s+/g, '');
                    const cleanIndex = cleanOriginal.indexOf(cleanText);
                    
                    if (cleanIndex !== -1) {
                        // 원본 텍스트에서 해당 위치 찾기
                        let originalIndex = 0;
                        let cleanIndexCount = 0;
                        
                        for (let i = 0; i < originalText.length; i++) {
                            if (!/\s/.test(originalText[i])) {
                                if (cleanIndexCount === cleanIndex) {
                                    startOffset = i;
                                    break;
                                }
                                cleanIndexCount++;
                            }
                            originalIndex++;
                        }
                        
                        if (startOffset !== -1) {
                            endOffset = startOffset + text.replace(/\s+/g, '').length;
                        }
                    }
                }
                
                if (startOffset !== -1 && endOffset !== -1) {
                    selectionStart = startOffset;
                    selectionEnd = endOffset;

                    // 선택된 텍스트 표시
                    showSelectedTextInfo(text, startOffset, endOffset);
                } else {
                    alert('선택된 텍스트를 원본 문서에서 찾을 수 없습니다.');
                }
            }
        }, 10);
        
        isSelecting = false;
    });
    
    // 선택된 텍스트 정보 표시 (라벨 선택 전)
    function showSelectedTextInfo(text, start, end) {
        // 전역 변수 설정
        selectedText = text;
        selectionStart = start;
        selectionEnd = end;
        
        // 상세 정보 패널에 선택된 텍스트 표시
        document.getElementById('selectedText').value = text;
        document.getElementById('entityType').value = '';
        document.querySelector('#selected-position').textContent = `위치: ${start}-${end}`;
    }
    
    // 선택 정보 표시 (라벨 선택 후)
    function showSelectionInfo(text, start, end) {
        const selectedTagButton = document.querySelector('.pii-tag-btn.selected');
        const tagName = selectedTagButton ? selectedTagButton.textContent.split('\n')[0] : 'Unknown';
        
        document.querySelector('#selected-tag-name').textContent = tagName;
        document.querySelector('#selected-text-preview').textContent = text;
        document.querySelector('#selected-position').textContent = `위치: ${start}-${end}`;
        
        selectionInfo.style.display = 'block';
    }
    
    // 선택 정보 숨기기
    function hideSelectionInfo() {
        selectionInfo.style.display = 'none';
        selectedText = '';
        selectionStart = 0;
        selectionEnd = 0;
        
        // 상세 정보 패널 초기화
        document.getElementById('selectedText').value = '';
        document.getElementById('entityType').value = '';
    }
    
    // 태그 확인 버튼
    confirmTagBtn.addEventListener('click', function() {
        if (!selectedTagType || !selectedText) {
            alert('태그 타입과 텍스트를 선택해주세요.');
            return;
        }
        
        // 태그 추가 API 호출
        addPiiTag(selectedTagType, selectedText, selectionStart, selectionEnd);
    });
    
    // 태그 취소 버튼
    cancelTagBtn.addEventListener('click', function() {
        hideSelectionInfo();
        clearSelection();
    });
    
    // 선택 초기화
    function clearSelection() {
        // 모든 태그 버튼에서 selected 클래스 제거
        tagButtons.forEach(btn => btn.classList.remove('selected'));
        selectedTagType = null;
        
        // 모든 기존 태그에서 selected 클래스 제거
        document.querySelectorAll('.existing-pii-tag').forEach(tag => {
            tag.classList.remove('selected');
        });
        
        // 문서 텍스트 커서 원래대로
        documentText.style.cursor = 'text';
        documentText.title = '';
        
        // 텍스트 선택 해제
        window.getSelection().removeAllRanges();
        
        // 선택된 텍스트 정보 초기화
        selectedText = '';
        selectionStart = 0;
        selectionEnd = 0;
        
        // 상세 정보 패널 초기화
        document.getElementById('selectedText').value = '';
        document.getElementById('entityType').value = '';
        document.getElementById('jsonDisplay').value = '';
    }
    
    // PII 태그 추가 함수
    function addPiiTag(tagType, text, start, end) {
        const formData = new FormData();
        formData.append('document_id', {{ document.id }});
        formData.append('pii_category_value', tagType);
        formData.append('span_text', text);
        formData.append('start_offset', start);
        formData.append('end_offset', end);
        formData.append('span_id', '');
        formData.append('entity_id', '');
        formData.append('annotator', '{{ user.username }}');
        formData.append('identifier_type', '');
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch('{% url "add_pii_tag" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 성공 시 페이지 새로고침
                location.reload();
            } else {
                alert('태그 추가 실패: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('오류가 발생했습니다.');
        })
        .finally(() => {
            hideSelectionInfo();
            clearSelection();
        });
    }
    
    // ESC 키로 선택 취소
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideSelectionInfo();
            clearSelection();
        }
    });
    
    // 전역 태그 삭제 함수
    window.deleteTag = function(tagId) {
        if (confirm('이 태그를 삭제하시겠습니까?')) {
            const formData = new FormData();
            formData.append('tag_id', tagId);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            fetch('{% url "delete_pii_tag" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 성공 시 페이지 새로고침
                    location.reload();
                } else {
                    alert('태그 삭제 실패: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('오류가 발생했습니다.');
            });
        }
    };
    
    // 기존 태그 선택 함수
    window.selectExistingTag = function(tagId) {
        const tagElement = document.querySelector(`[data-tag-id="${tagId}"]`);
        if (tagElement) {
            const tagData = JSON.parse(tagElement.dataset.tagData);
            
            // 상세 정보 패널 업데이트
            document.getElementById('selectedText').value = tagData.text;
            document.getElementById('entityType').value = tagData.category;
            document.getElementById('annotator').value = tagData.annotator || 'Anonymous';
            
            // 식별자 유형 설정
            const identifierTypeSelect = document.getElementById('identifierType');
            identifierTypeSelect.value = tagData.identifier_type || 'default';
            
            // 연결 드롭박스 업데이트
            updateLinkedAnnotationDropdown(tagId);
            
            // JSON 정보 생성
            const jsonData = {
                span_text: tagData.text,
                entity_type: tagData.category,
                start_offset: tagData.start,
                end_offset: tagData.end,
                span_id: tagData.span_id,
                entity_id: tagData.entity_id,
                annotator: tagData.annotator || "Anonymous",
                identifier_type: tagData.identifier_type || 'default'
            };
            
            document.getElementById('jsonDisplay').value = JSON.stringify(jsonData, null, 2);
            
            // 메타데이터 표시
            const metadata = {
                data_id: "{{ document.data_id }}",
                number_of_subjects: {{ document.number_of_subjects|default:0 }},
                provenance: {
                    dialog_type: "{{ document.dialog_type|default:'' }}",
                    turn_cnt: {{ document.turn_cnt|default:0 }},
                    doc_id: "{{ document.doc_id|default:'' }}"
                }
            };
            
            document.getElementById('metadata').value = JSON.stringify(metadata, null, 2);
            
            // 모든 태그에서 선택 상태 제거
            document.querySelectorAll('.existing-pii-tag').forEach(tag => {
                tag.classList.remove('selected');
            });
            
            // 선택된 태그에 선택 상태 추가
            tagElement.classList.add('selected');
            
            // 현재 태그 타입에 해당하는 버튼 선택
            const correspondingButton = document.querySelector(`[data-tag-type="${tagData.category}"]`);
            if (correspondingButton) {
                // 모든 태그 버튼에서 selected 클래스 제거
                document.querySelectorAll('.pii-tag-btn').forEach(btn => btn.classList.remove('selected'));
                // 해당 버튼에 selected 클래스 추가
                correspondingButton.classList.add('selected');
                selectedTagType = tagData.category;
            }
        }
    };
    
    // 기존 태그 타입 업데이트 함수
    function updateExistingTagType(tagElement, newType) {
        const tagId = tagElement.dataset.tagId;
        const identifierType = tagData.identifier_type || 'default';
        
        const formData = new FormData();
        formData.append('tag_id', tagId);
        formData.append('pii_category_value', newType);
        formData.append('identifier_type', identifierType);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch('{% url "update_pii_tag" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 태그 요소 업데이트
                tagElement.style.backgroundColor = data.new_color;
                tagElement.title = `${data.new_category}: ${tagElement.textContent}`;
                
                // 상세 정보 패널 업데이트
                document.getElementById('entityType').value = data.new_category;
                document.getElementById('annotator').value = "{{ user.username }}";  // 어노테이터 업데이트
                
                // JSON 정보 업데이트
                const tagData = JSON.parse(tagElement.dataset.tagData);
                const jsonData = {
                    span_text: tagData.text,
                    entity_type: data.new_category,
                    start_offset: tagData.start,
                    end_offset: tagData.end,
                    span_id: tagData.span_id,
                    entity_id: tagData.entity_id,
                    annotator: "{{ user.username }}",
                    identifier_type: identifierType
                };
                
                document.getElementById('jsonDisplay').value = JSON.stringify(jsonData, null, 2);
                
                // 태그 데이터 업데이트
                tagData.category = data.new_category;
                tagData.annotator = "{{ user.username }}";  // 로컬 데이터도 업데이트
                tagElement.dataset.tagData = JSON.stringify(tagData);
                
                console.log('태그 타입이 변경되었습니다:', data.new_category);
            } else {
                alert('태그 타입 변경 실패: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('오류가 발생했습니다.');
        });
    }
    
    // 키보드 단축키로 문서 네비게이션
    document.addEventListener('keydown', function(e) {
        // 입력 필드에 포커스가 있는 경우 단축키 비활성화
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
            return;
        }
        
        // Ctrl + ← : 이전 문서
        if (e.ctrlKey && e.key === 'ArrowLeft') {
            e.preventDefault();
            {% if prev_document %}
            window.location.href = "{% url 'document_detail' prev_document.pk %}";
            {% endif %}
        }
        
        // Ctrl + → : 다음 문서
        if (e.ctrlKey && e.key === 'ArrowRight') {
            e.preventDefault();
            {% if next_document %}
            window.location.href = "{% url 'document_detail' next_document.pk %}";
            {% endif %}
        }
    });

    // 페이지 로드 시 메타데이터 초기 표시
    document.addEventListener('DOMContentLoaded', function() {
        const metadata = {
            data_id: "{{ document.data_id }}",
            number_of_subjects: {{ document.number_of_subjects|default:0 }},
            provenance: {
                dialog_type: "{{ document.dialog_type|default:'' }}",
                turn_cnt: {{ document.turn_cnt|default:0 }},
                doc_id: "{{ document.doc_id|default:'' }}"
            }
        };
        
        document.getElementById('metadata').value = JSON.stringify(metadata, null, 2);
    });
});
</script>
{% endblock %}