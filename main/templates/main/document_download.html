{% extends 'main/base.html' %}

{% block title %}문서 다운로드 - PII Labeler{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAllBtn = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('input[name="selected_documents"]');
    const downloadBtn = document.getElementById('download-btn');
    
    // 전체 선택/해제 기능
    selectAllBtn.addEventListener('click', function() {
        const isChecked = this.checked;
        checkboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
        updateDownloadButton();
    });
    
    // 개별 체크박스 변경 시
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateDownloadButton();
            updateSelectAllState();
        });
    });
    
    function updateDownloadButton() {
        const selectedCount = document.querySelectorAll('input[name="selected_documents"]:checked').length;
        downloadBtn.disabled = selectedCount === 0;
        downloadBtn.textContent = selectedCount > 0 ? 
            `JSONL 다운로드 (${selectedCount}개 문서)` : 
            '문서를 선택해주세요';
    }
    
    function updateSelectAllState() {
        const totalCheckboxes = checkboxes.length;
        const checkedCheckboxes = document.querySelectorAll('input[name="selected_documents"]:checked').length;
        
        if (checkedCheckboxes === 0) {
            selectAllBtn.indeterminate = false;
            selectAllBtn.checked = false;
        } else if (checkedCheckboxes === totalCheckboxes) {
            selectAllBtn.indeterminate = false;
            selectAllBtn.checked = true;
        } else {
            selectAllBtn.indeterminate = true;
        }
    }
    
    // 초기 상태 설정
    updateDownloadButton();
});
</script>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-download"></i> 문서 다운로드</h2>
    <a href="{% url 'document_list' %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> 문서 목록으로
    </a>
</div>

{% if documents %}
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">다운로드할 문서 선택</h5>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="select-all">
                <label class="form-check-label" for="select-all">
                    전체 선택
                </label>
            </div>
        </div>
    </div>
    <div class="card-body">
        <form method="post" action="{% url 'download_jsonl' %}">
            {% csrf_token %}
            <div class="row">
                {% for document in documents %}
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       name="selected_documents" value="{{ document.id }}" 
                                       id="doc_{{ document.id }}">
                                <label class="form-check-label w-100" for="doc_{{ document.id }}">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="card-title mb-1">{{ document.data_id }}</h6>
                                            <p class="card-text small text-muted mb-2">
                                                {{ document.created_at|date:"Y-m-d H:i" }}
                                            </p>
                                            <p class="card-text small">
                                                {{ document.text|truncatewords:15 }}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <span class="badge bg-info">
                                            <i class="fas fa-tags"></i> {{ document.pii_tags.count }} PII 태그
                                        </span>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="mt-4 text-center">
                <button type="submit" class="btn btn-primary btn-lg" id="download-btn" disabled>
                    <i class="fas fa-download"></i> 문서를 선택해주세요
                </button>
            </div>
        </form>
    </div>
</div>

<div class="alert alert-info mt-4">
    <h6><i class="fas fa-info-circle"></i> 다운로드 정보</h6>
    <ul class="mb-0">
        <li>선택한 문서들이 JSONL 형식으로 다운로드됩니다</li>
        <li>각 문서의 PII 태그 정보도 함께 포함됩니다</li>
        <li>파일명: <code>documents_X.jsonl</code> (X는 선택된 문서 수)</li>
        <li>UTF-8 인코딩으로 저장됩니다</li>
    </ul>
</div>

{% else %}
<div class="text-center py-5">
    <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
    <h4 class="text-muted">다운로드할 문서가 없습니다</h4>
    <p class="text-muted">먼저 문서를 업로드해주세요.</p>
    <a href="{% url 'document_create' %}" class="btn btn-primary">
        <i class="fas fa-upload"></i> 문서 업로드
    </a>
</div>
{% endif %}
{% endblock %}
